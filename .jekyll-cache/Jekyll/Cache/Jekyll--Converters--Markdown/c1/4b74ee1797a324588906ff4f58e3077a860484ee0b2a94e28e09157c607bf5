I"ë8<p>è¿™æ˜¯ä¸€ä¸ªå¯¹railscast250çš„å­¦ä¹ ç¬”è®°ï¼Œæ‰€æœ‰copyright belongs to Railscastä½œè€… Ryan Bates</p>

<h3 id="1-åˆ›å»ºuser-model">1. åˆ›å»ºUser Model</h3>

<p><code>rails g resource user email password_digest</code></p>

<p>è¿™é‡Œæœ‰ä¸¤ç‚¹è¯´æ˜ï¼Œä¸€æ˜¯å…³äºrails g resourceï¼Œä½ å¯èƒ½å¯¹rails g scaffoldç†Ÿæ‚‰ï¼Œé‚£resourceæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåœ¨è¿™é‡Œï¼Œscaffoldå’Œresourceéƒ½æ˜¯rails generatorï¼Œå°±æ˜¯å¯ä»¥å¸®ä½ è‡ªåŠ¨ç”Ÿæˆå¾ˆå¤šçç¢çš„ä¸œè¥¿çš„åŠ©æ‰‹ï¼Œè¿™æ ·ä½ å°±ä¸ç”¨è‡ªå·±ä¸€éä¸€éå†™ç±»ä¼¼çš„ä¸œè¥¿äº†ã€‚resourceè·Ÿscaffoldæœ€ä¸»è¦çš„ä¸åŒæ˜¯ï¼Œresourceä¸ä¼šå¸®ä½ ç”Ÿæˆå¯¹åº”çš„controlleré‡Œé¢çš„ä»»ä½•ä¸ªactionä»¥åŠä»–ä»¬å¯¹åº”çš„ä»»ä½•viewï¼›ç¬¬äºŒç‚¹éœ€è¦è¯´æ˜çš„æ˜¯â€œpassword_digestâ€è¿™ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µæ¯”è¾ƒå…³é”®ï¼Œå› ä¸ºæ¥ä¸‹æ¥æˆ‘ä»¬è¦ç”¨åˆ°railsä¸ºæˆ‘ä»¬æä¾›çš„has_secure_passwordè¿™ä¸ªhelper methodï¼Œè¿™ä¸ªmethodé»˜è®¤éœ€è¦ç”¨åˆ°è¿™ä¸ªå­—æ®µã€‚</p>

<h3 id="2-migrate-database">2. Migrate database</h3>
<p>åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ<code>rake db:migrate</code>åˆ›å»ºä½ çš„database</p>

<h3 id="3-æ‰“å¼€modelé‡Œé¢çš„userrbåŠ ä¸Š-has_secure_password">3. æ‰“å¼€modelé‡Œé¢çš„user.rb,åŠ ä¸Š has_secure_password</h3>

<pre><code class="language-ruby">class User &lt; ActiveRecord::Base
    has_secure_password
end
</code></pre>
<p><code>has_secure_password</code>è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼Œåˆ©ç”¨å‰é¢æåˆ°çš„<code>password_digest</code>å­—æ®µï¼Œç»™ä½ æä¾›<code>password</code> å’Œ<code>password_confirmation</code>ä¸¤ä¸ªå­—æ®µï¼Œå¹¶å¸®ä½ åšä¸€äº›å¸¸è§çš„validationï¼Œæ¯”å¦‚ï¼šå¯†ç ä¸èƒ½ä¸ºç©ºï¼Œé•¿åº¦å¿…é¡»å°äº72å­—ç¬¦ï¼ŒæŠŠpasswordå’Œpassword_confirmationä¸¤ä¸ªå­—æ®µè¿›è¡Œå¯¹æ¯”ï¼Œç¡®ä¿ä»–ä»¬ç›¸ç­‰ï¼Œç­‰ç­‰ã€‚</p>

<h3 id="4-å®‰è£…bcrypt-gem">4. å®‰è£…bcrypt gem</h3>
<p>å‰é¢æåˆ°çš„has_secure_passwordè¿™ä¸ªæ–¹æ³•éœ€è¦ç”¨åˆ°ä¸€ä¸ªgemå«bcryptï¼Œè¿™ä¸ªgemåœ¨ä½ åˆ›å»ºprojectçš„æ—¶å€™é»˜è®¤å·²ç»åŠ åˆ°ä½ çš„Gemfileé‡Œé¢å»äº†ï¼Œåªä¸è¿‡é»˜è®¤è¢«æ³¨é‡Šæ‰äº†ã€‚æˆ‘ä»¬æ‰“å¼€Gemfileï¼Œæ‰¾åˆ°é‚£ä¸€è¡Œå¹¶uncommentæ‰ã€‚æ¥ç€æ‰§è¡Œ
<code>bundle install</code>
è¿›è¡Œå®‰è£…ï¼Œå®‰è£…å®Œè¿™ä¸ªgemä»¥åï¼Œé‡å¯rails serverè®©å®ƒç”Ÿæ•ˆã€‚</p>

<h3 id="5-æ·»åŠ extra-validation">5. æ·»åŠ extra validation</h3>
<p>æˆ‘ä»¬å¯ä»¥åœ¨User modelé‡Œé¢æ·»åŠ é¢å¤–çš„validationï¼Œæ¯”å¦‚emailä¸èƒ½ä¸ºç©ºï¼Œä¹Ÿå¿…é¡»å”¯ä¸€ï¼š</p>

<pre><code class="language-ruby">class User &lt; ActiveRecord::Base
  validates_presence_of :email
  validates_uniqueness_of :email

  has_secure_password
end
</code></pre>
<p>ä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œå†åŠ å…¶ä»–çš„validationï¼Œæ¯”å¦‚é‚®ç®±æ ¼å¼ï¼Œå¯†ç æœ€å°é•¿åº¦ç­‰ç­‰ã€‚</p>

<h3 id="6-æ·»åŠ controllerä»£ç ç”¨äºåˆ›å»ºç”¨æˆ·">6. æ·»åŠ controllerä»£ç ï¼Œç”¨äºåˆ›å»ºç”¨æˆ·ã€‚</h3>

<p>æ‰“å¼€app/controllers/users_controller.rb, æ·»åŠ new å’Œcreate action</p>

<pre><code class="language-ruby">class UsersController &lt; ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      redirect_to root_url
    else
      render new
    end
  end

  private
  def user_params
    params.require(:user).permit(:email, :password, :password_confirmation)
  end
end
</code></pre>
<p>è¿™äº›éƒ½æ˜¯rails æ ‡å‡†çš„newï¼Œcreate actionå†™æ³•ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚</p>

<h3 id="7-æ·»åŠ new-view">7. æ·»åŠ new view</h3>
<p>åœ¨app/views/users æ–‡ä»¶å¤¹ä¸‹é¢æ–°å»ºä¸€ä¸ªæ–‡ä»¶ new.html.erb, æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>

<pre><code class="language-ruby">&lt;h1&gt;Sign Up&lt;/h1&gt;
&lt;%= form_for @user do |f| %&gt;
&lt;% if @user.errors.any? %&gt;
&lt;div class="error_messages"&gt;
&lt;h2&gt;Form is invalid&lt;/h2&gt;
&lt;ul&gt;
&lt;% @user.errors.full_messages.each do |message| %&gt;
&lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;
&lt;% end %&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;% end %&gt;

&lt;div class="field"&gt;
&lt;%= f.label :email %&gt;&lt;br /&gt;
&lt;%= f.text_field :email %&gt;
&lt;/div&gt;
&lt;div class="field"&gt;
&lt;%= f.label :password %&gt;&lt;br /&gt;
&lt;%= f.password_field :password %&gt;
&lt;/div&gt;
&lt;div class="field"&gt;
     &lt;%= f.label :password_confirmation %&gt;&lt;br /&gt;
     &lt;%= f.password_field :password_confirmation %&gt;
&lt;/div&gt;
&lt;div class="actions"&gt;&lt;%= f.submit "Sign Up" %&gt;&lt;/div&gt;
&lt;% end %&gt;
</code></pre>
<p>&lt;/div&gt;
è¿™ä¸ªä¹Ÿæ˜¯æ ‡å‡†çš„new actionå†™æ³•ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚</p>

<h3 id="8-æ·»åŠ æ³¨å†Œçš„é“¾æ¥åˆ°é¡µé¢ä¸Š">8. æ·»åŠ æ³¨å†Œçš„é“¾æ¥åˆ°é¡µé¢ä¸Šã€‚</h3>

<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œä½ å¾ˆå¯èƒ½å¸Œæœ›åœ¨ä½ ç½‘ç«™çš„æ¯ä¸€ä¸ªé¡µé¢éƒ½æ˜¾ç¤ºæ³¨å†Œã€ç™»å½•çš„é“¾æ¥ï¼Œæ‰€ä»¥ï¼Œåœ¨è¿™é‡Œä¸€ä¸ªå¥½çš„åšæ³•æ˜¯å°†é“¾æ¥åŠ åˆ°application layouté‡Œé¢ã€‚å…·ä½“åŠ åˆ°ä»€ä¹ˆä½ç½®ï¼Œä»€ä¹ˆæ ·çš„styleç”±ä½ è§‰å¾—ï¼Œè¿™é‡Œæˆ‘ç®€å•åœ°å°†â€œsign upâ€é“¾æ¥åŠ åˆ°å³ä¸Šè§’ï¼Œå…±å‚è€ƒã€‚
æ‰“å¼€app/views/layouts/application.html.erb, åœ¨bodyåé¢åŠ ä¸Š</p>

<pre><code class="language-ruby">&lt;div class="user_navigation"&gt;
     &lt;%= link_to â€™Sign up', new_user_path %&gt;
&lt;/div&gt;
</code></pre>
<p>æ¥ä¸‹æ¥è®¾ç½®style,è®©é“¾æ¥é å³å¯¹é½å°±å¥½äº†ã€‚æ‰“å¼€app/assets/stylesheets/application.cssï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>

<pre><code class="language-css">.user_navigation {
     width: 100%;
     text-alignment: right;
}
</code></pre>
<p>è¿™æ ·ï¼Œæ‰“å¼€ä»»ä½•ä¸€ä¸ªç½‘é¡µï¼Œç‚¹å‡»å³ä¸Šè§’çš„loginï¼Œå°±å¯ä»¥è·³è½¬åˆ°æ³¨å†Œç”¨æˆ·çš„ç•Œé¢äº†(http://yourhost/users/new)ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p>åˆ°è¿™ä¸ªé¡µé¢è¾“å…¥é‚®ä»¶ï¼Œå¯†ç ï¼Œç¡®è®¤å¯†ç ï¼Œå°±å¯ä»¥æˆåŠŸåˆ›å»ºä¸€ä¸ªç”¨æˆ·äº†ã€‚</p>

<p>åˆ°è¿™é‡Œï¼Œå…³äºç”¨æˆ·æ³¨å†Œçš„éƒ¨åˆ†æˆ‘ä»¬åŸºæœ¬å°±åšå¥½äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰åšä»»ä½•å…³äºç”¨æˆ·ç™»å½•çš„äº‹æƒ…ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åšè¿™éƒ¨åˆ†å·¥ä½œã€‚</p>

<p>ç”¨æˆ·ç™»å½•ï¼š</p>
<h3 id="9-generate-ä¸€ä¸ªæ–°çš„controlleræ¥è´Ÿè´£ç™»é™†è¿™éƒ¨åˆ†é€»è¾‘é€šå¸¸è¿™ä¸ªcontrolleråå­—å«sessions-controller-æ‰§è¡Œ">9. generate ä¸€ä¸ªæ–°çš„controlleræ¥è´Ÿè´£ç™»é™†è¿™éƒ¨åˆ†é€»è¾‘ã€‚é€šå¸¸è¿™ä¸ªcontrolleråå­—å«sessions controller, æ‰§è¡Œï¼š</h3>
<p>rails g controller sessions new
è¿™æ ·å°±åˆ›å»ºäº†ä¸€ä¸ªsessions controllerï¼ŒåŒæ—¶è¿˜ç»™äº†ä»–ä¸€ä¸ªnew actionã€‚</p>

<h3 id="10-ä¿®æ”¹routesrb">10. ä¿®æ”¹routes.rb</h3>
<p>é€šè¿‡ä¸Šé¢çš„å‘½ä»¤ï¼Œrails è‡ªåŠ¨å¸®ä½ åœ¨routes.rbé‡Œé¢åŠ äº†ä¸€æ¡è®°å½•ï¼š
get â€˜sessions/newâ€™
ä½†å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œä¸€ä¸ªsessioné™¤äº†newï¼Œè¿˜è¦æœ‰createï¼Œdestroyè¿™äº›æ“ä½œï¼Œæ‰€ä»¥sessionå¯¹äºæˆ‘ä»¬æ¥è¯´æ›´åƒæ˜¯ä¸€ç§resourceï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠroutes.rbé‡Œé¢çš„é‚£æ¡è®°å½•åˆ äº†ï¼Œæ”¹æˆresourceå½¢å¼çš„routesï¼Œåœ¨routes.rbé‡Œé¢æ·»åŠ ä¸€è¡Œä»£ç ï¼š
resources sessions
è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰äº†sessionå¯¹åº”çš„æ ‡å‡†çš„resouceså½¢å¼çš„routesã€‚
åœ¨è¿™é‡Œä¹Ÿåšä¸€ä¸ªå°å°çš„è§£é‡Šï¼Œåœ¨æ ‡å‡†çš„rails actionä¸­ï¼Œnewçš„ä½œç”¨åªæ˜¯å‘ˆç°ä¸€ä¸ªè¡¨å•ç»™ç”¨æˆ·å¡«å†™ï¼ˆåœ¨è¿™é‡Œï¼Œæ˜¯ä¸€ä¸ªåˆ›å»ºsessionï¼Œå³ç™»é™†ï¼Œçš„è¡¨å•ï¼‰ï¼Œè€Œcreateçš„ä½œç”¨æ‰æ˜¯æ­£çœŸåˆ›å»ºè¿™ä¸ªsessionçš„è¿‡ç¨‹ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯æ‰§è¡Œç™»é™†æµç¨‹ï¼‰ã€‚</p>

<h3 id="11-åˆ›å»ºnew-sessionçš„view">11. åˆ›å»ºnew sessionçš„viewã€‚</h3>
<p>æ‰“å¼€app/views/sessions/new.html.erb, (è¿™ä¸ªæ–‡ä»¶åœ¨generate controllerçš„æ—¶å€™å°±å·²ç»å¸®ä½ åˆ›å»ºäº†ï¼Œä¸ç”¨è‡ªå·±æ–°å»ºï¼‰åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>

<pre><code>&lt;h1&gt;Log In&lt;/h1&gt;

&lt;%= form_tag sessions_path do %&gt;
&lt;div class="field"&gt;
&lt;%= label_tag :email %&gt;&lt;br /&gt;
&lt;%= text_field_tag :email, params[:email] %&gt;
&lt;/div&gt;
&lt;div class="field"&gt;
&lt;%= label_tag :password %&gt;&lt;br /&gt;
&lt;%= password_field_tag :password %&gt;
&lt;/div&gt;
&lt;div class="actions"&gt;&lt;%= submit_tag "Log In" %&gt;&lt;/div&gt;
&lt;% end %&gt;
</code></pre>
<p>è¿™ä¹Ÿæ˜¯ä¸€ä¸ªç®€å•çš„ç™»å½•formï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚
ç°åœ¨æ‰“å¼€http://localhost:3000/sessions/new ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªloginçš„è¡¨å•äº†ï¼Ÿ</p>

<h3 id="12-åœ¨ä¸Šé¢çš„è¡¨å•ä¸­ç‚¹å‡»ç™»é™†é¡µé¢å°†æ‰§è¡Œpost-åˆ°sessions-controllerçš„create-actionæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¦å†create-action-é‡Œé¢å†™æ‰§è¡Œç™»é™†è¿‡ç¨‹çš„ä»£ç ">12. åœ¨ä¸Šé¢çš„è¡¨å•ä¸­ï¼Œç‚¹å‡»ç™»é™†ï¼Œé¡µé¢å°†æ‰§è¡Œpost åˆ°sessions controllerçš„create actionï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¦å†create action é‡Œé¢å†™æ‰§è¡Œç™»é™†è¿‡ç¨‹çš„ä»£ç ã€‚</h3>
<p>æ‰“å¼€app/controllers/sessions_controller.rb, æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>

<pre><code class="language-ruby">def create
     user = User.find_by_email(params[:email])
     if user &amp;&amp; user.authenticate(params[:password])
          session[:user_id] = user.id
          redirect_to root_url, notice: 'Logged in!'
     else
          flash.now.alert = 'Email or password is invalid'
          render 'new'
     end
end
</code></pre>

<p>è¿™é‡Œç¨å¾®è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œç¬¬äºŒè¡ŒUser.find_by_email(params[:email]) æ ¹æ®emailæŸ¥æ‰¾ç”¨æˆ·ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸ªemailçš„ç”¨æˆ·ï¼Œåˆ™è¿”å›è¿™ä¸ªç”¨æˆ·ï¼Œå¦åˆ™è¿”å›nilï¼Œå¦‚æœç”¨æˆ·ä¸ä¸ºnilï¼Œåˆ™æ‰§è¡Œuser.authenticate(params[password])  è¿™ä¸ªæ–¹æ³•ï¼Œç”¨æ¥éªŒè¯å¯†ç æ˜¯ä¸æ˜¯æ­£ç¡®ã€‚è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å‰é¢æåˆ°çš„has_secure_passwordè¿™ä¸ªæ–¹æ³•ä¸ºæˆ‘ä»¬åˆ›å»ºçš„ã€‚å¦‚æœå¯†ç æ­£ç¡®ï¼Œåˆ™æŠŠuser idä¿å­˜åˆ°sessioné‡Œé¢ï¼Œè¿™é‡Œçš„sessionæ˜¯ä¸€ä¸ªç±»ä¼¼äºhashçš„å¯¹è±¡ï¼Œè¿™æ˜¯railsä¸ºæˆ‘ä»¬æä¾›çš„sessionæœºåˆ¶ã€‚</p>

<h3 id="13-åœ¨é¡µé¢ä¸ŠåŠ ä¸Šç™»é™†çš„é“¾æ¥">13. åœ¨é¡µé¢ä¸ŠåŠ ä¸Šç™»é™†çš„é“¾æ¥ã€‚</h3>
<p>è·Ÿå‰é¢æ·»åŠ æ³¨å†Œçš„é“¾æ¥ç±»ä¼¼ï¼Œè¿™é‡Œåœ¨application layouté‡Œé¢ç®€å•åŠ ä¸Šç™»é™†çš„é“¾æ¥ï¼š</p>

<pre><code class="language-html">&lt;div class="user_navigation"&gt;
     &lt;%= link_to â€™Sign up', new_user_path %&gt; or &lt;%= link_to 'Login', new_session_path %&gt;
&lt;/div&gt;
</code></pre>
<p>ç°åœ¨ï¼Œæ‰“å¼€ä»»ä½•ä¸€ä¸ªé¡µé¢ï¼Œåœ¨å³ä¸Šè§’éƒ½æœ‰â€œSign upâ€,å’Œâ€Login â€œçš„è¿æ¥äº†ï¼Œç‚¹å‡»loginï¼Œåˆ™ä¼šè·³è½¬åˆ°login çš„é¡µé¢ã€‚åœ¨é‚£ä¸ªé¡µé¢è¾“å…¥emailå’Œå¯†ç ï¼Œå°±å¯ä»¥è¿›è¡Œç™»å½•äº†ã€‚ç™»é™†å®Œä»¥åï¼Œæµè§ˆå™¨ä¼šè·³è½¬åˆ°rooté¡µé¢ã€‚
åˆ°è¿™é‡Œï¼ŒåŸºæœ¬çš„ç”¨æˆ·æ³¨å†Œå’Œç™»é™†æµç¨‹å°±å®Œæˆäº†ã€‚
ä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸ªå°é—®é¢˜ï¼Œä½ ç™»é™†å®Œäº†ä»¥åï¼Œå‘ç°å³ä¸Šè§’è¿˜æœ‰â€œsign upâ€å’Œâ€œloginâ€çš„é“¾æ¥ï¼Œè¿™ä¸ªä¸æ˜¯å¾ˆåˆç†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å®Œå–„ä¸€ä¸‹è¿™ä¸€ç‚¹ã€‚</p>

<h3 id="14-è¦è®©é¡µé¢æ ¹æ®ç›¸åº”çš„ç™»é™†çŠ¶æ€æ˜¾ç¤ºç›¸åº”åœ°å†…å®¹é¦–å…ˆæˆ‘ä»¬è¦æœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥è·å–ç”¨æˆ·æ˜¯å¦ç™»å½•è¿™ä¸ªä¿¡æ¯ç”±äºè¿™ä¸ªä¿¡æ¯ä¸€èˆ¬æ¥è¯´æ˜¯æ‰€æœ‰controllerå…±ç”¨çš„æ‰€ä»¥ä¸€ä¸ªå¥½çš„åšæ³•æ˜¯å°†è¿™ä¸ªä¸œè¥¿æ”¾åˆ°applicationcontrolleré‡Œé¢æ‰“å¼€appcontrollersapplication_controllerrbåœ¨applicationcontrollerç±»é‡Œé¢åŠ å…¥ä»¥ä¸‹ä»£ç ">14. è¦è®©é¡µé¢æ ¹æ®ç›¸åº”çš„ç™»é™†çŠ¶æ€æ˜¾ç¤ºç›¸åº”åœ°å†…å®¹ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥è·å–ç”¨æˆ·æ˜¯å¦ç™»å½•è¿™ä¸ªä¿¡æ¯ï¼Œç”±äºè¿™ä¸ªä¿¡æ¯ä¸€èˆ¬æ¥è¯´æ˜¯æ‰€æœ‰controllerå…±ç”¨çš„ï¼Œæ‰€ä»¥ä¸€ä¸ªå¥½çš„åšæ³•æ˜¯å°†è¿™ä¸ªä¸œè¥¿æ”¾åˆ°ApplicationControlleré‡Œé¢ï¼Œæ‰“å¼€app/controllers/application_controller.rbï¼Œåœ¨ApplicationControllerç±»é‡Œé¢åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š</h3>
<pre><code> def current_user
      @current_user ||= User.find(session[:user_id]) if session[:user_id]
 end å› ä¸ºæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„controlleréƒ½æ˜¯ç»§æ‰¿è‡ªApplicationControllerï¼Œæ‰€ä»¥è¿™æ ·çš„è¯ï¼Œæ‰€æœ‰çš„controlleréƒ½å¯ä»¥è°ƒç”¨current_userè¿™ä¸ªæ–¹æ³•æ¥åˆ¤æ–­å½“å‰æœ‰æ²¡æœ‰ç”¨æˆ·ç™»å½•äº†ã€‚ ç„¶è€Œè¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œåœ¨controlleré‡Œé¢ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥åˆ¤æ–­ç”¨æˆ·ç™»å½•ä¸å¦äº†ï¼Œä½†æ˜¯åœ¨viewé‡Œé¢ï¼Œæˆ‘ä»¬æ— æ³•è°ƒç”¨åˆ°è¿™ä¸ªcurrent_useræ–¹æ³•ï¼Œè¦åœ¨viewé‡Œé¢çŸ¥é“æœ‰æ²¡æœ‰ç”¨æˆ·ç™»å½•ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªhelper methodï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆæ–¹é¢çš„æ–¹æ³•æ˜¯åœ¨ApplicationControlleré‡Œé¢åŠ ä¸Šä¸€è¡Œï¼š helper_method :current_user è¿™æ ·ä¸‹æ¥ï¼Œcurrent_user ä¸ä»…ä»…æ˜¯ä¸€ä¸ªcontrolleré‡Œé¢çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªhelper methodï¼Œå¯ä»¥åœ¨viewé‡Œé¢è°ƒç”¨äº†ã€‚
</code></pre>

<h3 id="15-æ¥ä¸‹æ¥æˆ‘ä»¬é‡å†™application-layoutå…³äºsign-upå’Œloginè¿™ä¸¤ä¸ªé“¾æ¥çš„éƒ¨åˆ†åˆ©ç”¨current_user-helper-methodè·å–ç”¨æˆ·ç™»å½•çŠ¶æ€ç„¶ååˆ†åˆ«æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹æ‰“å¼€appviewslayoutsapplicationhtmlerb-å°†å‰é¢å†™çš„">15. æ¥ä¸‹æ¥æˆ‘ä»¬é‡å†™application layoutå…³äºsign upå’Œloginè¿™ä¸¤ä¸ªé“¾æ¥çš„éƒ¨åˆ†ï¼Œåˆ©ç”¨current_user helper methodè·å–ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œç„¶ååˆ†åˆ«æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹ã€‚æ‰“å¼€app/views/layouts/application.html.erb, å°†å‰é¢å†™çš„</h3>
<div class="user_navigation">
     &lt;%= link_to 'Sign up', new_user_path %&gt; or &lt;%= link_to 'Login', new_session_path %&gt;
</div>
<p>æ¢æˆä»¥ä¸‹çš„ä»£ç ï¼š</p>
<div class="user_navigation">
     &lt;% if current_user %&gt;
          Logged in as &lt;%= current_user.email %&gt;
     &lt;% else %&gt;
          &lt;%= link_to 'Sign up', new_user_path %&gt; or &lt;%= link_to 'Login', new_session_path %&gt;
     &lt;% end %&gt;
</div>
<p>ç°åœ¨ï¼Œç”¨æˆ·ç™»å½•åå³ä¸Šè§’å°†æ˜¾ç¤ºç”¨æˆ·çš„emailåœ°å€ï¼Œç„¶åæœªç™»é™†çš„æ—¶å€™å³ä¸Šè§’å°†æ˜¾ç¤ºSign upå’ŒLoginçš„é“¾æ¥ã€‚</p>

<h3 id="16-æ·»åŠ logoutçš„é“¾æ¥">16. æ·»åŠ logoutçš„é“¾æ¥ã€‚</h3>
<p>æˆ‘ä»¬ç»§ç»­å®Œå–„è¿™éƒ¨åˆ†çš„æµç¨‹ï¼Œå‰é¢æˆ‘ä»¬å·²ç»èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºç”¨æˆ·æ˜¯å¦ç™»å½•çš„çŠ¶æ€äº†ï¼Œä½†æˆ‘ä»¬è¿˜éœ€è¦ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªlogoutçš„é“¾æ¥ï¼Œè®©ç”¨æˆ·å¯ä»¥logoutï¼Œè€Œä¸ç”¨ç­‰sessionè‡ªåŠ¨è¿‡æœŸã€‚
ç”¨æˆ·logoutçš„è¿‡ç¨‹å…¶å®å°±æ˜¯è®©session destroyçš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦åœ¨sessions controlleré‡Œé¢æ·»åŠ ä¸€ä¸ªdestroy æ–¹æ³•ã€‚æ‰“å¼€app/controllers/sessions_controller.rbï¼Œåœ¨SessionsControllerç±»é‡Œé¢åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š
def destroy
     session[:user_id] = nil
     redirect_to root_url, notice: â€˜You have logged out!â€™
end
å¾ˆç®€å•ï¼Œå¯¹å§ï¼Œè®©è®©ç”¨æˆ·é€€å‡ºç™»å½•å…¶å®å°±æ˜¯æ¸…æ‰sessioné‡Œé¢çš„user_idå°±å¯ä»¥äº†ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»™é¡µé¢ä¸Šæ·»åŠ ä¸€ä¸ªlogouté“¾æ¥ï¼Œæ‰“å¼€app/views/layouts/application.html.erbï¼Œåœ¨åˆšåˆšæˆ‘ä»¬ä¿®æ”¹çš„é‚£æ®µä»£ç é‡Œé¢åŠ ä¸Šä¸€ä¸ªlinkï¼Œå¦‚ä¸‹ï¼š</p>
<div class="user_navigation">
     &lt;% if current_user %&gt;
          Logged in as &lt;%= current_user.email %&gt;
          &lt;%= link_to 'Logout', session_path('current'), method: :delete %&gt;
     &lt;% else %&gt;
          &lt;%= link_to 'Sign up', new_user_path %&gt; or &lt;%= link_to 'Login', new_session_path %&gt;
     &lt;% end %&gt;
</div>
<p>è¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬è¦triggler sessions controllerçš„destroy actionï¼Œæ‰€ä»¥æˆ‘ä»¬å£°æ˜è¯·æ±‚çš„æ–¹æ³•ä¸ºdeleteï¼Œè¿™ä¹Ÿæ˜¯railsçš„æ ‡å‡†routingæ–¹å¼ã€‚å¦å¤–ï¼Œtriggler sessions controllerçš„destroy actionéœ€è¦æˆ‘ä»¬æä¾›ä¸€ä¸ªidå‚æ•°ï¼Œæˆ‘ä»¬é€šè¿‡sessions_pathæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥è¿™ä¸ªidï¼Œè¿™é‡Œæˆ‘ä¼ å…¥çš„æ˜¯â€™currentâ€™ï¼Œä½†å…¶å®ä½ å›å»çœ‹çœ‹destroy actionçš„å®ç°æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªidï¼Œæ‰€ä»¥è¿™é‡Œä¼ å…¥ä»»ä½•å€¼éƒ½æ˜¯æ— æ‰€è°“çš„ã€‚</p>

<p>ç°åœ¨ï¼Œç™»é™†ä»¥åï¼Œå°±å¯ä»¥åœ¨emailå³è¾¹æ˜¾ç¤ºä¸€ä¸ªlogouté“¾æ¥äº†ã€‚</p>
:ET