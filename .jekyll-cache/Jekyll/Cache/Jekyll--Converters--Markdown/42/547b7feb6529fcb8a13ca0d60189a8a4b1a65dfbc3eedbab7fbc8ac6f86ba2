I"×%<p>åœ¨<a href="http://chriszou.com/2016/04/29/android-unit-testing-mockito.html">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬è®²äº†è¦å°†mockå‡ºæ¥çš„dependencyçœŸæ­£ä½¿ç”¨èµ·æ¥ï¼Œéœ€è¦åœ¨æµ‹è¯•ç¯å¢ƒä¸‹é€šè¿‡æŸç§æ–¹å¼set åˆ°ç”¨åˆ°å®ƒçš„é‚£ä¸ªå¯¹è±¡é‡Œé¢è¿›å»ï¼Œæ›¿æ¢æ‰çœŸå®çš„å®ç°ã€‚æˆ‘ä»¬å‰é¢ä¸¾çš„ä¾‹å­æ˜¯ï¼š</p>

<pre><code class="language-java">public class LoginPresenter {
    private UserManager mUserManager = new UserManager();

    public void login(String username, String password) {
        //ã€‚ã€‚ã€‚some other code
        mUserManager.performLogin(username, password);
    }
}
</code></pre>

<p>åœ¨æµ‹è¯•<code>LoginPresenter#login()</code>æ—¶ï¼Œä¸ºäº†èƒ½å¤Ÿå°†mockå‡ºæ¥çš„<code>UserManager</code> setåˆ°<code>LoginPresenter</code>é‡Œé¢ï¼Œæˆ‘ä»¬å‰é¢çš„åšæ³•æ˜¯ç®€å•ç²—æš´ï¼Œç»™<code>LoginPresenter</code>åŠ ä¸€ä¸ª<code>UserManager</code>çš„setterã€‚ç„¶è€Œè¿™ç§åšæ³•æ¯•ç«Ÿä¸æ˜¯å¾ˆä¼˜é›…ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ­£å¼ä»£ç é‡Œé¢æ˜¯ä¸ä¼šå»è°ƒç”¨è¿™ä¸ªsetterï¼Œä¿®æ”¹<code>UserManager</code>è¿™ä¸ªå¯¹è±¡çš„ã€‚å› æ­¤è¿™ä¸ªsetterå­˜åœ¨çš„æ„ä¹‰å°±çº¯ç²¹æ˜¯ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ã€‚è¿™ä¸ªè™½ç„¶ä¸æ˜¯æ²¡æœ‰å¿…è¦ï¼Œå´ä¸æ˜¯å¤ªå¥½çœ‹ï¼Œå› æ­¤åœ¨æœ‰é€‰æ‹©çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸è¿™ä¹ˆåšã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»‹ç»ä¾èµ–æ³¨å…¥è¿™ç§æ¨¡å¼ã€‚</p>

<p>å¯¹äºä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼Œä»¥ä¸‹ç®€ç§°DIï¼‰çš„å‡†ç¡®å®šä¹‰å¯ä»¥åœ¨<a href="https://en.wikipedia.org/wiki/Dependency_injection">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚å®ƒçš„åŸºæœ¬ç†å¿µè¿™è¾¹ç®€å•æè¿°ä¸‹ï¼Œé¦–å…ˆè¿™æ˜¯ä¸€ç§ä»£ç æ¨¡å¼ï¼Œè¿™ä¸ªæ¨¡å¼é‡Œé¢æœ‰ä¸¤ä¸ªæ¦‚å¿µï¼šClientå’ŒDependencyã€‚å‡å¦‚ä½ çš„ä»£ç é‡Œé¢ï¼Œä¸€ä¸ªç±»ç”¨åˆ°äº†å¦å¤–ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆå‰è€…å«Clientï¼Œåè€…å«Dependencyã€‚ç»“åˆä¸Šé¢çš„ä¾‹å­ï¼Œ<code>LoginPresenter</code>ç”¨åˆ°äº†<code>UserManager</code>ï¼Œé‚£ä¹ˆ<code>LoginPresenter</code>å«Clientï¼Œ<code>UserManager</code>å«Dependencyã€‚å½“ç„¶ï¼Œè¿™æ˜¯ä¸ªç›¸å¯¹çš„æ¦‚å¿µï¼Œä¸€ä¸ªç±»å¯ä»¥æ˜¯æŸä¸ªç±»çš„Dependencyï¼Œå´æ˜¯å¦å¤–ä¸€ä¸ªç±»çš„Clientã€‚æ¯”å¦‚è¯´å¦‚æœ<code>UserManager</code>é‡Œé¢ç”¨åˆ°äº†<code>Retrofit</code>ï¼Œé‚£ä¹ˆç›¸å¯¹äº<code>Retrofit</code>ï¼Œ<code>UserManager</code>åˆæ˜¯Clientã€‚DIçš„åŸºæœ¬æ€æƒ³å°±æ˜¯ï¼Œå¯¹äºDependencyçš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¹¶ä¸åœ¨Clienté‡Œé¢è¿›è¡Œï¼Œè€Œæ˜¯ç”±å¤–éƒ¨åˆ›å»ºå¥½ï¼Œç„¶åé€šè¿‡æŸç§æ–¹å¼setåˆ°Clienté‡Œé¢ã€‚è¿™ç§æ¨¡å¼ï¼Œå°±å«åšä¾èµ–æ³¨å…¥ã€‚</p>

<p>æ˜¯çš„ï¼Œä¾èµ–æ³¨å…¥å°±æ˜¯è¿™ä¹ˆç®€å•çš„ä¸€ä¸ªæ¦‚å¿µï¼Œè¿™è¾¹éœ€è¦æ¾„æ¸…çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸ªæ¦‚å¿µæœ¬èº«è·Ÿdagger2å•Šï¼ŒRoboGuiceè¿™äº›æ¡†æ¶å¹¶æ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚ç°åœ¨å¾ˆå¤šä»‹ç»DIçš„æ–‡ç« å¾€å¾€è·Ÿdagger2æ˜¯åœ¨ä¸€èµ·çš„ï¼Œå› ä¸ºdagger2çš„ä½¿ç”¨ç›¸å¯¹æ¥è¯´ä¸æ˜¯å¾ˆç›´è§‚ï¼Œæ‰€ä»¥å¯¼è‡´å¾ˆå¤šäººè®¤ä¸ºDIæ˜¯å¤šä¹ˆå¤æ‚çš„ä¸œè¥¿ï¼Œç”šè‡³è®¤ä¸ºåªèƒ½ç”¨daggerç­‰æ¡†æ¶æ¥å®ç°ä¾èµ–æ³¨å…¥ï¼Œå…¶å®ä¸æ˜¯è¿™æ ·çš„ã€‚å®ç°ä¾èµ–æ³¨å…¥å¾ˆç®€å•ï¼Œdaggerè¿™äº›æ¡†æ¶åªæ˜¯è®©è¿™ç§å®ç°å˜å¾—<strong>æ›´åŠ </strong>ç®€å•ï¼Œç®€æ´ï¼Œä¼˜é›…è€Œå·²ã€‚</p>

<h2 id="diçš„å¸¸è§å®ç°æ–¹å¼">DIçš„å¸¸è§å®ç°æ–¹å¼</h2>

<p>ä¸‹é¢ä»‹ç»DIçš„å®ç°æ–¹å¼ï¼Œé€šå¸¸æ¥è¯´ï¼Œè¿™é‡Œæ˜¯å¤§åŠ›ä»‹ç»dagger2çš„åœ°æ–¹ã€‚ä½†æ˜¯ï¼Œè™½ç„¶dagger2çš„ç¡®æ˜¯éå¸¸å¥½çš„ä¸œè¥¿ï¼Œç„¶è€Œå¦‚æœæˆ‘ç›´æ¥ä»‹ç»dagger2çš„è¯ï¼Œä¼šå¾ˆå®¹æ˜“å¯¼è‡´ä¸€ä¸ªè¯¯åŒºï¼Œè®¤ä¸ºåœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œä¹Ÿåªèƒ½ç”¨daggeræ¥åšä¾èµ–æ³¨å…¥æˆ–åˆ›å»ºå¯¹åº”çš„æµ‹è¯•ç±»ï¼Œå› æ­¤ï¼Œæˆ‘è¿™è¾¹åˆ»æ„ä¸ä»‹ç»daggerã€‚å…ˆè®©å¤§å®¶çŸ¥é“æœ€åŸºæœ¬çš„DIæ€ä¹ˆå®ç°ï¼Œç„¶ååœ¨æµ‹è¯•çš„æ—¶å€™å¦‚ä½•æ›´æ–¹ä¾¿é«˜æ•ˆçš„ä½¿ç”¨ã€‚</p>

<p>å®ç°DIè¿™ç§æ¨¡å¼å…¶å®å¾ˆç®€å•ï¼Œæœ‰å¤šç§æ–¹å¼ï¼Œä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„setterï¼Œå…¶å®å°±æ˜¯å®ç°DIçš„ä¸€ç§æ–¹å¼ï¼Œå«åš <em>setter injection</em> ã€‚æ­¤å¤–ï¼Œé€šè¿‡æ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›å»ï¼ˆ<em>argument injection</em>ï¼‰ï¼Œä¹Ÿæ˜¯å®ç°DIçš„ä¸€ç§æ–¹å¼ï¼š</p>

<pre><code class="language-java">public class LoginPresenter {

    //è¿™é‡Œï¼ŒLoginPresenterä¸å†æŒæœ‰UserManagerçš„ä¸€ä¸ªå¼•ç”¨ï¼Œè€Œæ˜¯ä½œä¸ºæ–¹æ³•å‚æ•°ç›´æ¥ä¼ è¿›å»
    public void login(UserManager userManager, String username, String password) {
        //... some other code
        userManager.performLogin(username, password);
    }
}
</code></pre>

<p>ç„¶è€Œæ›´å¸¸ç”¨çš„æ–¹å¼ï¼Œæ˜¯å°†Dependencyä½œä¸ºClientçš„æ„é€ æ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›å»ï¼š</p>

<pre><code class="language-java">public class LoginPresenter {

    private final UserManager mUserManager;

    //å°†UserManagerä½œä¸ºæ„é€ æ–¹æ³•å‚æ•°ä¼ è¿›æ¥
    public LoginPresenter(UserManager userManager) {
        this.mUserManager = userManager;
    }

    public void login(String username, String password) {
        //... some other code
        mUserManager.performLogin(username, password);
    }
}
</code></pre>

<p>è¿™ç§å®ç°DIçš„æ¨¡å¼å« <em>Constructor Injection</em>ã€‚å…¶å®ä¸€èˆ¬æ¥è¯´ï¼Œæåˆ°DIï¼ŒæŒ‡çš„éƒ½æ˜¯è¿™ç§æ–¹å¼ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ï¼Œä¾èµ–å…³ç³»éå¸¸æ˜æ˜¾ã€‚ä½ å¿…é¡»åœ¨åˆ›å»ºè¿™ä¸ªç±»çš„æ—¶å€™ï¼Œå°±æä¾›å¿…è¦çš„dependencyã€‚è¿™ä»æŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œä¹Ÿæ˜¯åœ¨è¯´æ˜è¿™ä¸ªç±»æ‰€å®Œæˆçš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œå°½é‡ä½¿ç”¨ <em>Constructor injection</em>ã€‚</p>

<p>è¯´åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœæŠŠä¾èµ–éƒ½å£°æ˜åœ¨Constructorçš„å‚æ•°é‡Œé¢ï¼Œè¿™ä¼šä¸ä¼šè®©è¿™ä¸ªç±»çš„Constructorå‚æ•°å˜å¾—éå¸¸å¤šï¼Ÿå¦‚æœçœŸçš„å‘ç”Ÿè¿™ç§æƒ…å†µäº†ï¼Œé‚£å¾€å¾€è¯´æ˜è¿™ä¸ªç±»çš„è®¾è®¡æ˜¯æœ‰é—®é¢˜çš„ï¼Œéœ€è¦é‡æ„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ä»£ç é‡Œé¢çš„ç±»ï¼Œä¸€èˆ¬å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯Dataç±»ï¼Œæ¯”å¦‚è¯´UserInfoï¼ŒOrderInfoç­‰ç­‰ã€‚å¦å¤–ä¸€ç§æ˜¯Serviceç±»ï¼Œæ¯”å¦‚<code>UserManager</code>, AudioPlayerç­‰ç­‰ã€‚æ‰€ä»¥è¿™ä¸ªé—®é¢˜å°±æœ‰ä¸¤ç§æƒ…å†µäº†ï¼š</p>

<ol>
  <li>å¦‚æœConstructoré‡Œé¢ä¼ å…¥çš„å¾ˆå¤šæ˜¯åŸºæœ¬ç±»å‹çš„æ•°æ®æˆ–æ•°æ®ç±»ï¼Œé‚£ä¹ˆæˆ–è®¸ä½ è¦åšçš„ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªï¼ˆæˆ–è€…æ˜¯å¦ä¸€ä¸ªï¼‰æ•°æ®ç±»æŠŠè¿™äº›æ•°æ®å°è£…ä¸€ä¸‹ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ä»·å€¼å¯æ˜¯å¤§å¤§æ»´ï¼è€Œä¸ä»…ä»…æ˜¯å°è£…ä¸€ä¸‹å‚æ•°çš„é—®é¢˜ï¼Œæœ‰äº†ä¸€ä¸ªç±»ï¼Œå¾ˆå¤šçš„æ–¹æ³•å°±å¯ä»¥æ”¾åˆ°è¿™ä¸ªç±»é‡Œé¢äº†ã€‚è¿™ç‚¹è¯·å‚è€ƒMartin Fowlerçš„ã€Šé‡æ„ã€‹ç¬¬åç« â€œIntroduce Parameter Objectâ€ã€‚</li>
  <li>å¦‚æœä¼ å…¥çš„å¾ˆå¤šæ˜¯serviceç±»ï¼Œé‚£ä¹ˆè¿™è¯´æ˜è¿™ä¸ªç±»åšçš„äº‹æƒ…å¤ªå¤šäº†ï¼Œä¸ç¬¦åˆå•ä¸€èŒè´£çš„åŸåˆ™ï¼ˆ<a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a>ï¼ŒSRPï¼‰ï¼Œå› æ­¤ï¼Œéœ€è¦é‡æ„ã€‚</li>
</ol>

<p>æ¥ä¸‹æ¥è¯´å›æˆ‘ä»¬çš„åˆè¡·ï¼šDIåœ¨æµ‹è¯•é‡Œé¢çš„åº”ç”¨ã€‚</p>

<h2 id="diåœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„åº”ç”¨">DIåœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„åº”ç”¨</h2>
<p>æ‰€è°“DIåœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„åº”ç”¨ï¼Œå…¶å®è¯´ç™½äº†å°±æ˜¯ä½¿ç”¨DIæ¨¡å¼ï¼Œå°†mockå‡ºæ¥çš„Dependency setåˆ°Clienté‡Œé¢å»ã€‚æˆ‘ç›¸ä¿¡è¿™ç¯‡æ–‡ç« è§£é‡Šåˆ°è¿™é‡Œï¼Œé‚£ä¹ˆç­”æ¡ˆä¹Ÿå°±æ¯”è¾ƒæ˜æ˜¾äº†ï¼Œä¸ºäº†å¼ºè°ƒæˆ‘ä»¬è¦å°½é‡ä½¿ç”¨ <em>Constructor injection</em>ï¼Œå¯¹äº <em>setter Injection</em> å’Œ <em>Argument injection</em> è¿™è¾¹å°±ä¸åšä»£ç ç¤ºä¾‹äº†ã€‚
å¦‚æœä½ çš„ä»£ç ä½¿ç”¨çš„æ˜¯ <em>Constructor injection</em>ï¼š</p>

<pre><code class="language-java">public class LoginPresenter {

    private final UserManager mUserManager;

    //å°†UserManagerä½œä¸ºæ„é€ æ–¹æ³•å‚æ•°ä¼ è¿›æ¥
    public LoginPresenter(UserManager userManager) {
        this.mUserManager = userManager;
    }

    public void login(String username, String password) {
        //... some other code
        mUserManager.performLogin(username, password);
    }
}
</code></pre>

<p>å…¶ä¸­æˆ‘ä»¬è¦æµ‹çš„æ–¹æ³•æ˜¯<code>login()</code>, è¦éªŒè¯<code>login()</code>æ–¹æ³•è°ƒç”¨äº†<code>mUserManager</code>çš„<code>performLigon()</code>ã€‚å¯¹åº”çš„æµ‹è¯•æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">public class LoginPresenterTest {

    @Test
    public void testLogin() {
        UserManager mockUserManager = Mockito.mock(UserManager.class);
        LoginPresenter presenter = new LoginPresenter(mockUserManager);  //åˆ›å»ºçš„æ—¶å€™ï¼Œè®²mockä¼ è¿›å»

        presenter.login("xiaochuang", "xiaochuang password");

        Mockito.verify(mockUserManager).performLogin("xiaochuang", "xiaochuang password");
    }
}
</code></pre>

<p>å¾ˆç®€å•ï¼Œå¯¹å§ã€‚</p>

<h2 id="å°ç»“">å°ç»“</h2>
<p>è¿™ç¯‡æ–‡ç« ä»‹ç»äº†DIçš„æ¦‚å¿µï¼Œä»¥åŠåœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„åº”ç”¨ï¼Œè¿™é‡Œç‰¹æ„æ²¡æœ‰ä»‹ç»dagger2çš„ä½¿ç”¨ï¼Œç›®çš„æ˜¯è¦å¼ºè°ƒï¼š</p>

<ol>
  <li>ä¸€ä¸ªçµæ´»çš„ï¼Œæ˜“äºæµ‹è¯•çš„ï¼Œç¬¦åˆSRPçš„ï¼Œç»“æ„æ¸…æ™°çš„é¡¹ç›®ï¼Œå…³é”®åœ¨äºè¦åº”ç”¨ä¾èµ–æ³¨å…¥è¿™ç§æ¨¡å¼ï¼Œè€Œä¸æ˜¯ç”¨ä»€ä¹ˆæ¥åšä¾èµ–æ³¨å…¥ã€‚</li>
  <li>ç­‰ä½ å­¦ä¼šä½¿ç”¨daggerä»¥åï¼Œè¦è®°å¾—åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œå¦‚æœå¯ä»¥ç›´æ¥mock dependencyå¹¶ä¼ ç»™è¢«æµ‹ç±»ï¼Œé‚£å°±ç›´æ¥åˆ›å»ºï¼Œä¸æ˜¯ä¸€å®šè¦ä½¿ç”¨daggeræ¥åšDI</li>
</ol>

<p>ç„¶è€Œå¦‚æœå®Œå…¨ä¸ä½¿ç”¨æ¡†æ¶æ¥åšDIï¼Œé‚£ä¹ˆåœ¨æ­£å¼ä»£ç é‡Œé¢å°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œé‚£å°±æ˜¯dependencyçš„åˆ›å»ºå·¥ä½œå°±äº¤ç»™ä¸Šå±‚clientå»å¤„ç†äº†ï¼Œè¿™å¯ä¸æ˜¯ä»¶å¥½äº‹æƒ…ã€‚æƒ³æƒ³çœ‹ï¼Œ<code>LoginActivity</code>é‡Œé¢åˆ›å»º<code>LoginPresenter</code>çš„æ—¶å€™ï¼Œè¿˜å¾—çŸ¥é“<code>LoginPresenter</code>ç”¨äº†<code>UserManager</code>ã€‚ç„¶ååˆ›å»ºä¸€ä¸ª<code>UserManager</code>å¯¹è±¡ç»™<code>LoginPresenter</code>ã€‚å¯¹äº<code>LoginActivity</code>æ¥è¯´ï¼Œå®ƒè§‰å¾—æˆ‘æ‰æ‡’å¾—ç®¡ä½ ç”¨ä»€ä¹ˆæ ·çš„<code>UserManager</code>å‘¢ï¼Œæˆ‘åªæƒ³å‘Šè¯‰ä½ loginçš„æ—¶å€™ï¼Œä½ ç»™æˆ‘è€è€å®å®çš„loginå°±å¥½äº†ï¼Œä½ ç”¨ä»€ä¹ˆManageræˆ‘ä¸ç®¡ã€‚æ‰€ä»¥ï¼Œç›´æ¥åœ¨<code>LoginActivity</code>é‡Œé¢åˆ›å»º<code>UserManager</code>ï¼Œå¯èƒ½ä¸æ˜¯ä¸ªå¥½çš„é€‰æ‹©ã€‚é‚£æ€ä¹ˆæ ·ç®—æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©å‘¢ï¼Ÿdagger2ç»™äº†æˆ‘ä»¬ç­”æ¡ˆã€‚
äºæ˜¯ä¸‹ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»dagger2ã€‚</p>

<p>æ–‡ä¸­çš„ä»£ç åœ¨<a href="https://github.com/ChrisZou/android-unit-testing-tutorial">githubè¿™ä¸ªé¡¹ç›®é‡Œé¢</a>ã€‚</p>

<p>æœ€åï¼Œå¦‚æœä½ å¯¹å®‰å“å•å…ƒæµ‹è¯•æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„äº¤æµç¾¤ï¼Œå› ä¸ºç¾¤æˆå‘˜è¶…è¿‡100äººï¼Œæ²¡åŠæ³•æ‰«ç åŠ å…¥ï¼Œè¯·å…³æ³¨ä¸‹æ–¹å…¬ä¼—å·è·å–åŠ å…¥æ–¹æ³•ã€‚</p>
:ET