I"æ<p>Otto: No more callbacks
ä½ è¦åšä¸€ä¸ªtodo appï¼Œæœ‰ä¸€ä¸ªActivityé‡Œé¢æœ‰ä¸€ä¸ªListViewæ˜¾ç¤ºä½ æ‰€æœ‰çš„<code>task</code>ï¼Œä½ çš„æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨ã€‚å‡è®¾ä½ æ²¡é‡‡ç”¨ä»»ä½•çš„è½¯ä»¶æ¶æ„ï¼ˆMVCã€MVPã€MVVMç­‰ç­‰ï¼‰ï¼Œæ¯æ¬¡appæ‰“å¼€çš„æ—¶å€™ï¼Œä½ ä»æœåŠ¡å™¨æŠŠæ•°æ®loadä¸‹æ¥ï¼Œloadå®Œäº†ä»¥åï¼Œé€šè¿‡callbackæŠŠæ•°æ®ä¼ ç»™Activityï¼Œç„¶åæ˜¾ç¤ºåˆ°listviewé‡Œé¢ã€‚ä»£ç ç»“æ„å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­</p>

<pre><code class="language-Java">public class TasksActivity extends Activity {
	private ListView mListView;
	//...
	private void loadTasks() {
		TaskModel model = new TaskModel();
		model.setTaskCallback(new TaskCallback() {
			public void onError(String msg, int code) {
				// handle error
			}

			public void onSucceed(List&lt;Task&gt; tasks) {
				updateTaskList(tasks);
			}
		});
		model.loadTasks();
	}

	private void updateTaskList(List&lt;Task&gt; tasks) {
		//Update the task list view
	}
	// other code
}

public class Task {
	// title, label, ..., and their getters and setters.
}

public class TaskModel {
	public void loadTasks() {
		//load tasks from server, when result returns, check if callback is not null and call callback
	}

	private TaskCallback mTaskCallback;
	public void setTaskCallback(TaskCallback callback) {
		this.mTaskCallback = callback;
	}

	public static interface TaskCallback {
		public void onError(String errorMsg, int code);
		public void onSucceed(List&lt;Task&gt; tasks);
	}
}
</code></pre>

<p>è¿™é‡Œï¼Œä½ ç”¨çš„æ˜¯callbackæ¥é€šçŸ¥Activityï¼Œtaskå·²ç»loadå¥½äº†ã€‚è¿™ç§callbackçš„æ–¹å¼æ˜¯javaé‡Œé¢éå¸¸ä¼ ç»Ÿçš„æ–¹å¼ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°å¼‚æ­¥çš„æ—¶å€™ã€‚è¿™ç§æ–¹å¼è™½ç„¶èƒ½workï¼Œä½†å´æ˜¯éå¸¸éº»çƒ¦ï¼Œä¹Ÿéå¸¸ä¸‘é™‹çš„æ–¹å¼ã€‚<br />
é¦–å…ˆï¼Œä½ è¦å®šä¹‰Callbackæ¥å£ï¼Œç„¶ååœ¨ç”¨çš„åœ°æ–¹å®ç°è¿™ä¸ªæ¥å£ã€‚<br />
å†æ¬¡ï¼Œä½ è¦åœ¨ä½ çš„modelé‡Œé¢ç”³æ˜ä¸€ä¸ªcallbackçš„æˆå‘˜å˜é‡ï¼Œåœ¨ç”¨çš„æ—¶å€™ï¼Œè¿˜è¦åˆ¤æ–­ä¸€ä¸‹æˆå‘˜å˜é‡æ˜¯ä¸æ˜¯ç©ºçš„ã€‚å½“ç„¶ä½ å¯ä»¥ç”¨<a href="http://en.wikipedia.org/wiki/Null_Object_pattern">NullObject</a> æ¨¡å¼ï¼Œä½†è¿™ä¹Ÿéœ€è¦é¢å¤–çš„å·¥ä½œã€‚<br />
æœ€åï¼Œå½“ä½ å‘ç°å®šä¹‰çš„callbackæ¥å£è¦å˜çš„æ—¶å€™ï¼Œä½ è¦æ”¹åŠ¨çš„åœ°æ–¹å¯èƒ½éå¸¸å¤§ï¼Œå› ä¸ºä½ å¯èƒ½æœ‰å¾ˆå¤šçš„åœ°æ–¹å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œè¿™æ˜¯éå¸¸çƒ¦äººä¹Ÿæ˜¯éå¸¸å®¹æ˜“å‡ºé”™çš„å·¥ä½œã€‚<br />
è¿™ä¸€æ¥äºŒå»ï¼Œå½“ä½ çš„modelæ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œä½ ä¼šå˜å¾—éå¸¸çƒ¦ï¼Œè¿™å®Œå…¨å°±æ˜¯ä½“åŠ›åŠ³åŠ¨å•Šï¼<br />
é‚£æœ‰æ²¡æœ‰æ›´å¥½åœ°æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä½ å¯èƒ½ä¼šæƒ³åˆ°æ˜¯<code>Handler</code>æˆ–è€…æ˜¯<code>BroadcastReceiver</code>ï¼Œç„¶è€Œä»–ä»¬ä¹Ÿä¸æ˜¯å¾ˆå¥½ç”¨çš„ä¸œè¥¿ï¼Œéƒ½è¦å®šä¹‰ä¸€äº›ä¸œè¥¿ï¼Œåˆ¤æ–­messageï¼Œåˆ¤æ–­actionï¼Œä¼ é€’ä¸€äº›å¼•ç”¨ç­‰ç­‰ã€‚<br />
è¿™é‡Œä»‹ç»ä¸€ä¸ªlibraryå«<a href="https://github.com/square/otto">Otto</a>ï¼Œè¿™æ˜¯Squareè¿™ä¸ªå…¬å¸çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒæ˜¯ä¸€ä¸ªEventBusçš„libraryã€‚ç®€å•çš„æ¥è¯´ï¼Œå®ƒç±»ä¼¼äºå®šä¹‰äº†ä¸€å¥—Observer Patternçš„ä¾¿æ·çš„å®ç°æ–¹å¼ã€‚ä½ åœ¨æŸä¸€ä¸ªåœ°æ–¹ä½¿ç”¨<code>@Subscribe</code> è¡¨ç¤ºä½ è¦å¤„ç†æŸä¸€ç§äº‹ä»¶ï¼Œåœ¨æŸä¸ªåœ°æ–¹ç”¨postå‘å¸ƒè¿™ä¸€ç§äº‹ä»¶ï¼Œé‚£ä¹ˆå‰é¢ç”¨<code>@Subscribe</code>ä¿®é¥°çš„æ–¹æ³•å°±å¯ä»¥è‡ªåŠ¨å¾—åˆ°è°ƒç”¨ã€‚ä¸ç”¨å®šä¹‰æ¥å£ï¼Œä¸ç”¨å®ç°æ¥å£ï¼Œä¸€åˆ‡éƒ½å¾ˆç›´è§‚ï¼Œå¦‚ä½ æ‰€æ„¿ã€‚<br />
å…³äºOttoçš„ä½¿ç”¨<a href="http://square.github.io/otto/">å®˜ç½‘</a>è¯´çš„éå¸¸æ¸…æ¥šã€‚<br />
åœ¨è¿™é‡Œç®€å•åœ°ç”¨Ottoé‡å†™ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œè®©å¤§å®¶æ„Ÿå—ä¸€ä¸‹ã€‚</p>

<pre><code class="language-Java">public class TasksActivity extends Activity {
	private ListView mListView;
	public void onCreate() {
		OttoHelper.register(this); //å¯¹äºSubscriberæ¥è¯´ï¼Œregisterå’Œunregisteræ˜¯æœ‰å¿…è¦çš„
	}
	//...
	private void loadTasks() {
		new TaskModel().loadTasks();
	}

	// ç”¨@Subscribe æ¥è¡¨ç¤ºç”¨è¿™ä¸ªæ–¹æ³•å¤„ç†æŸç§äº‹ä»¶ï¼Œè¿™ç§äº‹ä»¶å°±æ˜¯ä½ çš„æ–¹æ³•çš„å‚æ•°ã€‚
	// æ­¤å¤–ï¼Œpublic voidæ˜¯å¿…é¡»çš„ï¼Œæ–¹æ³•åå¯ä»¥è‡ªå·±éšä¾¿å–
 	@Subscribe
	public void onTaskLoaded(TaskLoadedEvent event) {
		List&lt;Task&gt; tasks = event.tasks;
		// Update the task list view
	}

	@Subscribe
	public void onTaskLoadError(TaskLoadErrorEvent event) {
		//handler error
	}

	public void onDestroy() {
		OttoHelper.unregister(this)
	}
}

public class Task {
	// title, label, ..., and their getters and setters.
}

public class TaskModel {
	public void loadTasks() {
		// Load task from server
		OttoHelper.post(new TaskLoadedEvent(tasks)); //If load succeed
		OttoHelper.post(new TaskErrorEvent(errorMsg, code); //If load error
	}
}

//Bus ä¸€èˆ¬æ˜¯ç”¨ä½œå•ä¾‹çš„ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªhelperä¼šå¾ˆæ–¹ä¾¿
public class OttoHelper {
	private static final Bus sBusInstance = new Bus();
	public void static register(Object obj) {
		sBusInstance.register(obj);
	}

	public void static unregister(Object obj) {
		sBusInstance.register(obj);
	}

	public static void post(Object event) {
		sBusInstance.post(event);
	}

}

public class TaskLoadedEvent {
	public final List&lt;Task&gt; tasks;
	public TaskLoadedEvent(List&lt;Task&gt; tasks) {
		this.tasks = tasks;
	}
}

public class TaskLoadErrorEvent {
	//final field errorMsg and code, and construction, just like TaskLoadedEvent
}
</code></pre>

<p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™é‡Œåªå¤„ç†äº†ä¸€ç§äº‹ä»¶ï¼ˆload taskï¼‰ï¼Œæ‰€ä»¥Ottoçš„ä¼˜åŠ¿è¿˜ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œç„¶è€Œä½ ä¾ç„¶å¯ä»¥æ˜æ˜¾æ„Ÿå—åˆ°çš„æ˜¯ï¼Œ<code>TaskModel</code>å’Œ<code>TasksActivity</code>ä¹‹é—´çš„è€¦åˆæ€§æ›´å¼±äº†ã€‚ä»–ä»¬ä¹‹é—´é™¤äº†éƒ½ç”¨äº†<code>Task</code>å’Œ<code>OttoHelper</code>è¿™ä¸¤ä¸ªç±»ä»¥åŠç”¨æ¥ä¼ é€’äº‹ä»¶çš„Eventç±»ï¼Œå†æ²¡æœ‰å…¶ä»–å…±åŒçš„ä¸œè¥¿ã€‚</p>

<p>å½“äº‹ä»¶å¤šäº†èµ·æ¥ï¼ŒOttoçš„ä¼˜åŠ¿å°±ä¼šéå¸¸æ˜æ˜¾ï¼Œå¢åŠ çš„åªæ˜¯Eventè¿™äº›è½»é‡çº§çš„POJOè€Œå·²ã€‚<br />
éå¸¸éœ€è¦çš„ä¸€ç‚¹æ˜¯ï¼Œæœ€å¥½æ¯ä¸€ç§äº‹ä»¶éƒ½ä½¿ç”¨ç‰¹æ®Šçš„Eventç±»ï¼Œåƒä¸‡ä¸è¦ä½¿ç”¨å¸¸è§çš„ç±»ï¼Œæ¯”å¦‚Stringç­‰ç­‰ï¼Œæ›´ä¸è¦ä½¿ç”¨Objectï¼Œå› ä¸ºOttoåˆ¤æ–­Subscribeæ–¹æ³•æ‰€å¤„ç†çš„äº‹ä»¶æ˜¯é€šè¿‡æ–¹æ³•çš„å‚æ•°æ¥åˆ¤æ–­çš„ã€‚åªè¦ <code>instance of</code>ä¸ºtrueï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±ä¼šå¾—åˆ°è°ƒç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸Šé¢çš„TasksActivityé‡Œï¼Œå‡å¦‚ä½ æœ‰å¦å¤–ä¸€ä¸ªSubscribeå‡½æ•°ï¼Œå®ƒçš„å‚æ•°æ˜¯Objectï¼š</p>

<pre><code class="language-Java">public class TasksActivity extends Activity {
	//...
	@Subscribe
	public void onTaskLoaded(TaskLoadedEvent event) {
		List&lt;Task&gt; tasks = event.tasks;
		// Update the task list view
	}

	@Subscribe
	public void onTaskLoadError(TaskLoadErrorEvent event) {
		//handler error
	}

	@Subscribe
	public void onSomeEvent(Object event) {
		//handle some-event
	}
}
</code></pre>

<p>åœ¨ä¸Šé¢çš„äº‹ä»¶ä¸­ï¼Œbus postçš„ä»»ä½•äº‹ä»¶ï¼Œä¸»è¦TasksActivityæ²¡æœ‰unregisterï¼Œé‚£ä¹ˆ<code>onSomeEvent</code>å°±ä¼šå¾—åˆ°è°ƒç”¨ï¼Œæ¯”å¦‚task loadæˆåŠŸäº†ï¼Œä½ postäº†TaskLoadedEventï¼Œé‚£ä¹ˆé™¤äº†<code>onTaskLoaded</code>ä¼šå¾—åˆ°è°ƒç”¨çš„ä¹‹å¤–ï¼Œ<code>onSomeEvent</code>ä¹Ÿä¼šå¾—åˆ°è°ƒç”¨ï¼Œè¿™å¾ˆå¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚<br />
æˆ‘æ›¾ç»å°±çŠ¯äº†è¿™ä¸ªæ„šè ¢çš„é”™è¯¯ï¼Œæ›´æç¬‘çš„æ˜¯ï¼Œæˆ‘åœ¨<code>onSomeEvent</code>é‡Œé¢ç›´æ¥finish activityäº†ï¼Œç»“æœæ¯ä¸€æ¬¡åˆ«çš„äº‹ä»¶è¿‡æ¥ï¼ŒActivityå°±é€€å‡ºäº†ï¼Œæˆ‘ä»¥ä¸ºç¨‹åºå¥”æºƒäº†ï¼Œæ‰¾äº†åŠå¤©éƒ½æ‰¾ä¸å‡ºåŸå› ï¼Œå› ä¸ºä½ æ­£å¸¸finish activityæ˜¯ä¸ä¼šæœ‰error logçš„ï¼Œæœ€åç»ˆäºæ€€ç–‘åˆ°å®ƒå¤´ä¸Šæ¥ï¼Œç„¶åæ‰è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚<br />
æŠŠ <code>compile 'com.squareup:otto:1.3.7â€™</code>åŠ åˆ°ä½ çš„dependenciesé‡Œé¢ï¼Œè¯•ç”¨ä»¥ä¸‹ï¼Œæˆ‘æ•¢æ‰“èµŒï¼Œä½ å†ä¹Ÿä¸ä¼šå®šä¹‰callbackäº†ï¼ŒCallbacks should be dead!.<br />
å½“ç„¶ï¼Œé™¤äº†Ottoï¼Œè¿˜æœ‰å…¶ä»–çš„ä¸€äº›libraryï¼Œæ¯”å¦‚greenbotå¼€æºçš„EventBusï¼ŒåŠŸèƒ½è²Œä¼¼æ¯”Ottoæ›´å¼ºï¼Œä½†æ˜¯æˆ‘ä¸ªäººé€‰æ‹©Ottoï¼Œå› ä¸ºä¿¡ä»°Squareï¼Œå“ˆå“ˆã€‚ã€‚</p>

<h3 id="disclaimer">Disclaimer</h3>
<p>è¿™ä¸ªä¾‹å­åªæ˜¯ç”¨æ¥è¯´æ˜Ottoç›¸å¯¹äºcallbackçš„å¥½å¤„ï¼Œå¯¹äºä¸€ä¸ªæ­£å¸¸çš„ç±»ä¼¼äºä¸Šé¢çš„ä¾‹å­çš„appï¼Œè¿™ç¯‡æ–‡ç« ä¸­æåˆ°çš„modelå’Œactivityçš„äº¤äº’æ–¹å¼å¹¶ä¸æ˜¯æœ€å¥½çš„æ–¹å¼ï¼Œæœ‰å…¶ä»–æ›´å¥½çš„æ¯”å¦‚Functional Reactive Programmingï¼ˆRxJavaï¼‰ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨MVPæ¨¡å¼ï¼ŒæŠŠActivityå½“åšViewï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨é‡Œé¢è°ƒç”¨modelã€‚</p>

<p>å¦‚æœæœ‰ä»»ä½•æ„è§æˆ–å»ºè®®ï¼Œæˆ–è€…æ˜¯å‘ç°æ–‡ä¸­æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿ç•™è¨€ï¼<br />
ä¸ªäººåšå®¢ï¼šhttp://www.chriszou.com æ¬¢è¿äº¤æµï¼</p>
:ET