I"‰³<blockquote>
  <p>æ³¨ï¼š</p>
  <ol>
    <li>ä»£ç ä¸­çš„ //&lt;= è¡¨ç¤ºæ–°åŠ çš„ã€ä¿®æ”¹çš„ç­‰éœ€è¦é‡ç‚¹å…³æ³¨çš„ä»£ç </li>
    <li>Class#methodè¡¨ç¤ºä¸€ä¸ªç±»çš„instance methodï¼Œæ¯”å¦‚ LoginPresenter#login è¡¨ç¤º LoginPresenterçš„loginï¼ˆéé™æ€ï¼‰æ–¹æ³•ã€‚</li>
  </ol>
</blockquote>

<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>åœ¨<a href="http://chriszou.com/2016/05/06/android-unit-testing-di.html">å‰ä¸€ç¯‡æ–‡ç« </a>ä¸­ï¼Œæˆ‘ä»¬è®²è¿°äº†ä¾èµ–æ³¨å…¥çš„æ¦‚å¿µï¼Œä»¥åŠä¾èµ–æ³¨å…¥å¯¹å•å…ƒæµ‹è¯•æå…¶å…³é”®çš„é‡è¦æ€§å’Œå¿…è¦æ€§ã€‚åœ¨é‚£ç¯‡æ–‡ç« çš„ç»“å°¾ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœä¸ä½¿ç”¨DIæ¡†æ¶ï¼Œè€Œå…¨éƒ¨é‡‡ç”¨æ‰‹å·¥æ¥åšDIçš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„Dependencyéƒ½éœ€è¦åœ¨æœ€ä¸Šå±‚çš„clientæ¥ç”Ÿæˆï¼Œè¿™å¯ä¸æ˜¯ä»¶å¥½äº‹æƒ…ã€‚ç»§ç»­ç”¨æˆ‘ä»¬å‰é¢çš„ä¾‹å­æ¥å…·ä½“è¯´æ˜ä¸€ä¸‹ã€‚<br />
å‡è®¾æœ‰ä¸€ä¸ªç™»å½•ç•Œé¢ï¼Œ<code>LoginActivity</code>ï¼Œä»–æœ‰ä¸€ä¸ª<code>LoginPresenter</code>ï¼Œ<code>LoginPresenter</code>ç”¨åˆ°äº†<code>UserManager</code>å’Œ<code>PasswordValidator</code>ï¼Œä¸ºäº†è®©é—®é¢˜å˜å¾—æ›´æ˜æ˜¾ä¸€ç‚¹ï¼Œæˆ‘ä»¬å‡è®¾<code>UserManager</code>ç”¨åˆ°<code>SharedPreference</code>ï¼ˆç”¨æ¥å­˜å‚¨ä¸€äº›ç”¨æˆ·çš„åŸºæœ¬è®¾ç½®ç­‰ï¼‰å’Œ<code>UserApiService</code>ï¼Œè€Œ<code>UserApiService</code>åˆéœ€è¦ç”±<code>Retrofit</code>åˆ›å»ºï¼Œè€Œ<code>Retrofit</code>åˆç”¨åˆ°<code>OkHttpClient</code>ï¼ˆæ¯”å¦‚è¯´ä½ è¦è‡ªå·±æ§åˆ¶timeoutã€cacheç­‰ä¸œè¥¿ï¼‰ã€‚<br />
åº”ç”¨DIæ¨¡å¼ï¼ŒUserManagerçš„è®¾è®¡å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">public class UserManager {
    private final SharedPreferences mPref;
    private final UserApiService mRestAdapter;

    public UserManager(SharedPreferences preferences, UserApiService userApiService) {
        this.mPref = preferences;
        this.mRestAdapter = userApiService;
    }

    /**Other code*/
}
</code></pre>

<p>LoginPresenterçš„è®¾è®¡å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">public class LoginPresenter {
    private final UserManager mUserManager;
    private final PasswordValidator mPasswordValidator;

    public LoginPresenter(UserManager userManager, PasswordValidator passwordValidator) {
        this.mUserManager = userManager;
        this.mPasswordValidator = passwordValidator;
    }

    /**Other code*/
}
</code></pre>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€ç»ˆçš„client LoginActivityé‡Œé¢è¦newä¸€ä¸ªpresenterï¼Œéœ€è¦åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">
public class LoginActivity extends AppCompatActivity {
    private LoginPresenter mLoginPresenter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        OkHttpClient okhttpClient = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .build();
        Retrofit retrofit = new Retrofit.Builder()
                .client(okhttpClient)
                .baseUrl("https://api.github.com")
                .build();
        UserApiService userApiService = retrofit.create(UserApiService.class);
        SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
        UserManager userManager = new UserManager(preferences, userApiService);

        PasswordValidator passwordValidator = new PasswordValidator();
        mLoginPresenter = new LoginPresenter(userManager, passwordValidator);
    }
}
</code></pre>

<p>è¿™ä¸ªä¹Ÿå¤ªå¤¸å¼ äº†ï¼Œ<code>LoginActivity</code>æ‰€éœ€è¦çš„ï¼Œä¸è¿‡æ˜¯ä¸€ä¸ª<code>LoginPresenter</code>è€Œå·²ï¼Œç„¶è€Œå®ƒå´éœ€è¦çŸ¥é“<code>LoginPresenter</code>çš„Dependencyæ˜¯ä»€ä¹ˆï¼Œ<code>LoginPresenter</code>çš„Dependencyçš„Dependencyåˆæ˜¯ä»€ä¹ˆï¼Œç„¶ånewä¸€å †ä¸œè¥¿å‡ºæ¥ã€‚è€Œä¸”å¯ä»¥é¢„è§çš„æ˜¯ï¼Œè¿™ä¸ªappçš„å…¶ä»–åœ°æ–¹ä¹Ÿéœ€è¦è¿™é‡Œçš„<code>OkHttpClient</code>ã€<code>Retrofit</code>ã€<code>SharedPreference</code>ã€<code>UserManager</code>ç­‰ç­‰dependencyï¼Œå› æ­¤ä¹Ÿéœ€è¦newè¿™äº›ä¸œè¥¿å‡ºæ¥ï¼Œé€ æˆå¤§é‡çš„ä»£ç é‡å¤ï¼Œå’Œä¸å¿…è¦çš„object instanceç”Ÿæˆã€‚ç„¶è€Œå¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬åˆå¿…é¡»ç”¨åˆ°DIæ¨¡å¼ï¼Œè¿™ä¸ªæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>

<p>æƒ³æƒ³ï¼Œå¦‚æœèƒ½è¾¾åˆ°è¿™æ ·çš„æ•ˆæœï¼Œé‚£è¯¥æœ‰å¤šå¥½ï¼šæˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªç±»ä¼¼äºdependencyå·¥å‚çš„åœ°æ–¹ç»Ÿä¸€ç”Ÿäº§è¿™äº›dependencyï¼Œä»¥åŠè¿™äº›dependencyçš„dependencyã€‚æ‰€æœ‰éœ€è¦ç”¨åˆ°è¿™äº›Dependencyçš„clientéƒ½ä»è¿™ä¸ªå·¥å‚é‡Œé¢å»è·å–ã€‚è€Œä¸”æ›´å¦™çš„æ˜¯ï¼Œä¸€ä¸ªclientï¼ˆæ¯”å¦‚è¯´<code>LoginActivity</code>ï¼‰åªéœ€è¦çŸ¥é“å®ƒç›´æ¥ç”¨åˆ°çš„Dependencyï¼ˆ<code>LoginPresenter</code>ï¼‰ï¼Œè€Œä¸éœ€è¦çŸ¥é“å®ƒçš„Dependencyï¼ˆ<code>LoginPresenter</code>ï¼‰åˆç”¨åˆ°å“ªäº›Dependencyï¼ˆ<code>UserManager</code>å’Œ<code>PasswordValidator</code>ï¼‰ã€‚ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å‡ºè¿™ä¸ªä¾èµ–å…³ç³»ï¼Œä»å·¥å‚é‡Œé¢æŠŠéœ€è¦çš„Dependencyæ‰¾åˆ°ï¼Œç„¶åæŠŠè¿™ä¸ªclientæ‰€éœ€è¦çš„Dependencyåˆ›å»ºå‡ºæ¥ã€‚</p>

<p>æœ‰è¿™æ ·ä¸€ä¸ªä¸œè¥¿ï¼Œå¸®æˆ‘ä»¬å®ç°è¿™ä¸ªæ•ˆæœå—ï¼Ÿç›¸ä¿¡èªæ˜çš„ä½ å·²ç»çŒœåˆ°äº†ï¼Œå›ç­”æ˜¯è‚¯å®šçš„ï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦ä»‹ç»çš„dagger2ã€‚</p>

<h2 id="è§£è¯dagger2">è§£è¯ï¼šDagger2</h2>
<p>åœ¨dagger2é‡Œé¢ï¼Œè´Ÿè´£ç”Ÿäº§è¿™äº›Dependencyçš„ç»Ÿä¸€å·¥å‚å«åš <strong><em>Module</em></strong> ï¼Œæ‰€æœ‰çš„clientæœ€ç»ˆæ˜¯è¦ä»moduleé‡Œé¢è·å–Dependencyçš„ï¼Œç„¶è€Œä»–ä»¬ä¸æ˜¯ç›´æ¥å‘moduleè¦çš„ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªä¸“é—¨çš„â€œå·¥å‚ç®¡ç†å‘˜â€ï¼Œè´Ÿè´£æ¥æ”¶clientçš„è¦æ±‚ï¼Œç„¶ååˆ°Moduleé‡Œé¢å»æ‰¾åˆ°ç›¸åº”çš„Dependencyï¼Œæä¾›ç»™clientä»¬ã€‚è¿™ä¸ªâ€œå·¥å‚ç®¡ç†å‘˜â€å«åš <strong><em>Component</em></strong>ã€‚åŸºæœ¬ä¸Šï¼Œè¿™æ˜¯dagger2é‡Œé¢æœ€é‡è¦çš„ä¸¤ä¸ªæ¦‚å¿µã€‚</p>

<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œå¯¹åº”åˆ°ä»£ç é‡Œé¢ï¼Œæ˜¯æ€ä¹ˆæ ·çš„ã€‚</p>

<h3 id="ç”Ÿäº§dependencyçš„å·¥å‚module">ç”Ÿäº§Dependencyçš„å·¥å‚ï¼šModule</h3>
<p>é¦–å…ˆæ˜¯Moduleï¼Œä¸€ä¸ªModuleå¯¹åº”åˆ°ä»£ç é‡Œé¢å°±æ˜¯ä¸€ä¸ªç±»ï¼Œåªä¸è¿‡è¿™ä¸ªç±»éœ€è¦ç”¨dagger2é‡Œé¢çš„ä¸€ä¸ªannotation <code>@Module</code>æ¥æ ‡æ³¨ä¸€ä¸‹ï¼Œæ¥è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªModuleï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ã€‚æˆ‘ä»¬è¯´Moduleæ˜¯ç”Ÿäº§Dependencyçš„åœ°æ–¹ï¼Œå¯¹åº”åˆ°ä»£ç é‡Œé¢å°±æ˜¯Moduleé‡Œé¢æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åšçš„äº‹æƒ…å°±æ˜¯åˆ›å»ºDependencyã€‚ç”¨ä¸Šé¢çš„ä¾‹å­ä¸­çš„Dependencyæ¥è¯´æ˜ï¼š</p>

<pre><code class="language-java">@Module
public class AppModule {

    public OkHttpClient provideOkHttpClient() {
        OkHttpClient okhttpClient = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .build();
        return okhttpClient;
    }

    public Retrofit provideRetrofit(OkHttpClient okhttpClient) {
        Retrofit retrofit = new Retrofit.Builder()
                .client(okhttpClient)
                .baseUrl("https://api.github.com")
                .build();
        return retrofit;
    }
}
</code></pre>

<p>åœ¨ä¸Šé¢çš„Moduleï¼ˆ<code>AppModule</code>ï¼‰ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•<code>provideOkHttpClient()</code>å’Œ<code>provideRetrofit(OkHttpClient okhttpClient)</code>ï¼Œåˆ†åˆ«åˆ›å»ºäº†ä¸¤ä¸ªDependencyï¼Œ<code>OkHttpClient</code>å’Œ<code>Retrofit</code>ã€‚ä½†æ˜¯å‘¢ï¼Œæˆ‘ä»¬ä¹Ÿè¯´äº†ï¼Œä¸€ä¸ªModuleå°±æ˜¯ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»æœ‰ä¸€äº›ç”Ÿäº§Dependencyçš„æ–¹æ³•ï¼Œä½†å®ƒä¹Ÿå¯ä»¥æœ‰ä¸€äº›æ­£å¸¸çš„ï¼Œä¸æ˜¯ç”¨æ¥ç”Ÿäº§Dependencyçš„æ–¹æ³•ã€‚é‚£æ€ä¹ˆæ ·è®©ç®¡ç†å‘˜çŸ¥é“ï¼Œä¸€ä¸ªModuleé‡Œé¢å“ªäº›æ–¹æ³•æ˜¯ç”¨æ¥ç”Ÿäº§Dependencyçš„ï¼Œå“ªäº›ä¸æ˜¯å‘¢ï¼Ÿä¸ºäº†æ–¹ä¾¿åšè¿™ä¸ªåŒºåˆ†ï¼Œdagger2è§„å®šï¼Œæ‰€æœ‰ç”Ÿäº§Dependencyçš„æ–¹æ³•å¿…é¡»ç”¨ <code>@Provides</code>è¿™ä¸ªannotationæ ‡æ³¨ä¸€ä¸‹ã€‚æ‰€ä»¥ï¼Œä¸Šé¢çš„ <code>AppModule</code>æ­£ç¡®çš„å†™æ³•åº”è¯¥æ˜¯ï¼š</p>

<pre><code class="language-java">@Module
public class AppModule {
    @Provides
    public OkHttpClient provideOkHttpClient() {
        OkHttpClient okhttpClient = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .build();
        return okhttpClient;
    }

    @Provides
    public Retrofit provideRetrofit(OkHttpClient okhttpClient) {
        Retrofit retrofit = new Retrofit.Builder()
                .client(okhttpClient)
                .baseUrl("https://api.github.com")
                .build();
        return retrofit;
    }
}
</code></pre>

<p>è¿™ç§ç”¨æ¥ç”Ÿäº§Dependencyçš„ã€ç”¨ <code>@Provides</code>ä¿®é¥°è¿‡çš„æ–¹æ³•å«<strong>Provideræ–¹æ³•</strong>ã€‚è¿™é‡Œè¦æ³¨æ„ç¬¬äºŒä¸ªProvideræ–¹æ³• <code>provideRetrofit(OkHttpClient okhttpClient)</code>ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯<code>OkHttpClient</code>ã€‚è¿™æ˜¯å› ä¸ºåˆ›å»ºä¸€ä¸ª<code>Retrofit</code>å¯¹è±¡éœ€è¦ä¸€ä¸ª<code>OkHttpClient</code>çš„å¯¹è±¡ï¼Œè¿™é‡Œé€šè¿‡å‚æ•°ä¼ é€’è¿›æ¥ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå½“Clientå‘ç®¡ç†å‘˜ï¼ˆComponentï¼‰ç´¢è¦ä¸€ä¸ª<code>Retrofit</code>çš„æ—¶å€™ï¼ŒComponentä¼šè‡ªåŠ¨æ‰¾åˆ°Moduleé‡Œé¢æ‰¾åˆ°ç”Ÿäº§Retrofitçš„è¿™ä¸ª <code>provideRetrofit(OkHttpClient okhttpClient)</code>æ–¹æ³•ï¼Œæ‰¾åˆ°ä»¥åè¯•å›¾è°ƒç”¨è¿™ä¸ªæ–¹æ³•åˆ›å»ºä¸€ä¸ª<code>Retrofit</code>å¯¹è±¡ï¼Œè¿”å›ç»™Clientã€‚ä½†æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•éœ€è¦ä¸€ä¸ª<code>OkHttpClient</code>ï¼Œäºæ˜¯Componentåˆä¼šå»æ‰¾å…¶ä»–çš„provideræ–¹æ³•ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å“ªä¸ªä¼šç”Ÿäº§<code>OkHttpClient</code>ã€‚äºæ˜¯å°±æ‰¾åˆ°äº†ä¸Šé¢çš„ç¬¬ä¸€ä¸ªprovideræ–¹æ³•ï¼š <code>provideOkHttpClient()</code>ã€‚æ‰¾åˆ°ä»¥åï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª<code>OkHttpClient</code>å¯¹è±¡ï¼Œå†è°ƒç”¨ <code>provideRetrofit(OkHttpClient okhttpClient)</code>æ–¹æ³•ï¼ŒæŠŠåˆšåˆšåˆ›å»ºçš„<code>OkHttpClient</code>å¯¹è±¡ä¼ è¿›å»ï¼Œåˆ›å»ºå‡ºä¸€ä¸ª<code>Retrofit</code>å¯¹è±¡ï¼Œè¿”å›ç»™Clientã€‚å½“ç„¶ï¼Œå¦‚æœæœ€åæ‰¾åˆ°çš„ <code>provideOkHttpClient()</code>æ–¹æ³•ä¹Ÿéœ€è¦å…¶ä»–å‚æ•°ï¼Œé‚£ä¹ˆç®¡ç†å‘˜è¿˜ä¼šç»§ç»­é€’å½’çš„æ‰¾ä¸‹å»ï¼Œç›´åˆ°æ‰€æœ‰çš„Dependencyéƒ½è¢«æ»¡è¶³äº†ï¼Œå†ä¸€ä¸ªä¸€ä¸ªåˆ›å»ºDependencyï¼Œç„¶åæŠŠæœ€ç»ˆClientéœ€è¦çš„Dependencyå‘ˆé€’ç»™Clientã€‚<br />
å¾ˆå¥½ï¼Œç°åœ¨æˆ‘ä»¬æŠŠæ–‡ç« å¼€å¤´çš„ä¾‹å­ä¸­çš„æ‰€æœ‰Dependencyéƒ½ç”¨è¿™ç§æ–¹å¼ï¼Œåœ¨ <code>AppModule</code>é‡Œé¢å£°æ˜ä¸€ä¸ªprovideræ–¹æ³•ï¼š</p>

<pre><code class="language-java">@Module
public class AppModule {
    @Provides
    public OkHttpClient provideOkHttpClient() {
        OkHttpClient okhttpClient = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .build();
        return okhttpClient;
    }

    @Provides
    public Retrofit provideRetrofit(OkHttpClient okhttpClient) {
        Retrofit retrofit = new Retrofit.Builder()
                .client(okhttpClient)
                .baseUrl("https://api.github.com")
                .build();
        return retrofit;
    }

    @Provides
    public UserApiService provideUserApiService(Retrofit retrofit) {
        return retrofit.create(UserApiService.class);
    }

    @Provides
    public SharedPreferences provideSharedPreferences(Context context) {
        return PreferenceManager.getDefaultSharedPreferences(context);
    }

    @Provides
    public UserManager provideUserManager(SharedPreferences preferences, UserApiService service) {
        return new UserManager(preferences, service);
    }

    @Provides
    public PasswordValidator providePasswordValidator() {
        return new PasswordValidator();
    }

    @Provides
    public LoginPresenter provideLoginPresenter(UserManager userManager, PasswordValidator validator) {
        return new LoginPresenter(userManager, validator);
    }
}
</code></pre>

<p>ä¸Šé¢çš„ä»£ç å¦‚æœä½ ä»”ç»†çœ‹çš„è¯ï¼Œä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å…¶ä¸­çš„SharedPreference provideræ–¹æ³• <code>provideSharedPreferences(Context context)</code>éœ€è¦ä¸€ä¸ªcontextå¯¹è±¡ï¼Œä½†æ˜¯ <code>AppModule</code>é‡Œé¢å¹¶æ²¡æœ‰context çš„Provideræ–¹æ³•ï¼Œè¿™ä¸ªæ€ä¹ˆåŠå‘¢ï¼Ÿå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œä½ å¯ä»¥å†åˆ›å»ºä¸€ä¸ªcontext provideræ–¹æ³•ï¼Œä½†æ˜¯contextå¯¹è±¡ä»å“ªæ¥å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªApplicationï¼Œé‡Œé¢æä¾›ä¸€ä¸ªé™æ€æ–¹æ³•è¿”å›ä¸€ä¸ªcontextï¼Œè¿™ç§åšæ³•ç›¸ä¿¡å¤§å®¶éƒ½å¹²è¿‡ã€‚Applicationç±»å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">public class MyApplication extends Application {
    private static Context sContext;

    @Override
    public void onCreate() {
        super.onCreate();
        sContext = this;
    }

    public static Context getContext() {
        return sContext;
    }
}
</code></pre>

<p>provideræ–¹æ³•å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">    @Provides
    public Context provideContext() {
        return MyApplication.getContext();
    }
</code></pre>

<p>ä½†æ˜¯è¿™ç§æ–¹æ³•ä¸æ˜¯å¾ˆå¥½ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸ºcontextçš„è·å¾—ç›¸å½“äºæ˜¯å†™æ­»äº†ï¼Œåªèƒ½ä»MyApplication.getContext()ï¼Œå¦‚æœæµ‹è¯•ç¯å¢ƒä¸‹æƒ³æŠŠContextæ¢æˆåˆ«çš„ï¼Œè¿˜è¦ç»™MyApplicationå®šä¹‰ä¸€ä¸ªsetterï¼Œç„¶åè°ƒç”¨MyApplication.setContext(â€¦)ï¼Œè¿™ä¸ªå°±ç»•çš„æœ‰ç‚¹è¿œã€‚æ›´å¥½çš„åšæ³•æ˜¯ï¼ŒæŠŠContextä½œä¸º <code>AppModule</code>çš„ä¸€ä¸ªæ„é€ å‚æ•°ï¼Œä»å¤–é¢ä¼ è¿›æ¥ï¼ˆåº”ç”¨DIæ¨¡å¼ï¼Œè¿˜è®°å¾—å—ï¼Ÿï¼‰ï¼š</p>

<pre><code class="language-java">@Module
public class AppModule {
    private final Context mContext;

    public AppModule(Context context) {
        this.mContext = context;
    }

    @Provides
    public Context provideContext() {
        return mContext;
    }

    //å…¶ä»–çš„provideræ–¹æ³•

}

</code></pre>

<p>æ˜¯çš„ï¼Œä¸€ä¸ªModuleå°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ç±»ï¼Œå®ƒä¹Ÿå¯ä»¥æœ‰æ„é€ æ–¹æ³•ï¼Œä»¥åŠå…¶ä»–æ­£å¸¸ç±»çš„ç‰¹æ€§ã€‚ä½ å¯èƒ½ä¼šæƒ³é‚£ç»™æ„é€ å‡½æ•°çš„contextå¯¹è±¡ä»å“ªæ¥å‘¢ï¼Ÿåˆ«æ€¥ï¼Œè¿™ä¸ªé—®é¢˜é©¬ä¸Šè§£ç­”ã€‚</p>

<h2 id="dependencyå·¥å‚ç®¡ç†å‘˜component">Dependencyå·¥å‚ç®¡ç†å‘˜ï¼šComponent</h2>
<p>å‰é¢æˆ‘ä»¬è®²äº†dagger2çš„ä¸€åŠï¼Œå°±æ˜¯ç”Ÿäº§Dependencyçš„å·¥å‚ï¼šModuleã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è®²å¦ä¸€åŠï¼Œå·¥å‚ç®¡ç†å‘˜ï¼šComponentã€‚è·ŸModuleä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å®ç°Componentæ—¶ï¼Œä¸æ˜¯å®šä¹‰ä¸€ä¸ªç±»ï¼Œè€Œæ˜¯å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆinterfaceï¼‰ï¼š</p>

<pre><code class="language-java">public interface AppComponent {
}
</code></pre>

<p>åå­—å¯ä»¥éšä¾¿å–ï¼Œè·ŸModuleéœ€è¦ç”¨ <code>@Module</code>ä¿®é¥°ä¸€ä¸‹ç±»ä¼¼çš„ï¼Œä¸€ä¸ªdagger2çš„Componentéœ€è¦ç”¨ <code>@Component</code>ä¿®é¥°ä¸€ä¸‹ï¼Œæ¥æ ‡æ³¨è¿™æ˜¯ä¸€ä¸ªdagger2çš„Componentï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„interfaceï¼Œæ‰€ä»¥æ­£ç¡®çš„å®šä¹‰æ–¹å¼æ˜¯ï¼š</p>

<pre><code class="language-java">@Component
public interface AppComponent {
}
</code></pre>

<p>åœ¨å®é™…æƒ…å†µä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªModuleï¼Œä¹Ÿå¯èƒ½æœ‰å¤šä¸ªComponentï¼Œé‚£ä¹ˆå½“Componentæ¥æ”¶åˆ°ä¸€ä¸ªClientçš„Dependencyè¯·æ±‚æ—¶ï¼Œå®ƒæ€ä¹ˆçŸ¥é“è¦ä»å“ªä¸ªModuleé‡Œé¢å»æ‰¾è¿™äº›Dependencyå‘¢ï¼Ÿå®ƒä¸å¯èƒ½éå†æˆ‘ä»¬çš„æ¯ä¸€ä¸ªç±»ï¼Œç„¶åæ‰¾å‡ºæ‰€æœ‰çš„Moduleï¼Œå†éå†æ‰€æœ‰Moduleçš„Provideræ–¹æ³•ï¼Œå»æ‰¾Dependencyï¼Œè¿™æ ·å…ˆä¸è¯´èƒ½ä¸èƒ½åšåˆ°ï¼Œå°±ç®—åšå¾—åˆ°ï¼Œæ•ˆç‡ä¹Ÿå¤ªä½äº†ã€‚å› æ­¤dagger2è§„å®šï¼Œæˆ‘ä»¬åœ¨å®šä¹‰Componentçš„æ—¶å€™ï¼Œå¿…é¡»æŒ‡å®šè¿™ä¸ªç®¡ç†å‘˜â€œç®¡ç†â€å“ªäº›å·¥å‚ï¼ˆModuleï¼‰ã€‚æŒ‡å®šçš„æ–¹æ³•æ˜¯ï¼ŒæŠŠéœ€è¦è¿™ä¸ªComponentç®¡ç†çš„Moduleä¼ ç»™ <code>@Component</code>è¿™ä¸ªæ³¨è§£çš„moduleså±æ€§ï¼ˆæˆ–è€…å«æ–¹æ³•ï¼Ÿï¼‰ï¼Œå¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">@Component(modules = {AppModule.class})  //&lt;=
public interface AppComponent {
}
</code></pre>

<p>moduleså±æ€§æ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢æ˜¯è¿™ä¸ªComponentç®¡ç†çš„æ‰€æœ‰Moduleã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>AppComponent</code>åªç®¡ç†<code>AppModule</code>ä¸€ä¸ªã€‚</p>

<h3 id="componentç»™clientæä¾›dependencyçš„æ–¹æ³•">Componentç»™Clientæä¾›Dependencyçš„æ–¹æ³•</h3>

<p>å‰é¢æˆ‘ä»¬è®²äº†Moduleå’ŒComponentçš„å®ç°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯Componentæ€ä¹ˆç»™Clientæä¾›Dependencyçš„é—®é¢˜äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ‰ä¸¤ç§ï¼Œå½“ç„¶æ€»å…±ä¸æ­¢è¿™ä¸¤ç§ï¼Œåªä¸è¿‡è¿™ä¸¤ç§æœ€å¸¸ç”¨ï¼Œä¹Ÿæœ€å¥½ç†è§£ï¼Œä¸€èˆ¬æ¥è¯´ç”¨è¿™ä¸¤ç§å°±å¤Ÿäº†ï¼Œå› æ­¤è¿™é‡Œä¸èµ˜è¿°å…¶ä»–çš„æ–¹æ³•ã€‚</p>

<h4 id="æ–¹æ³•ä¸€åœ¨componenté‡Œé¢å®šä¹‰ä¸€ä¸ªè¿”å›dependencyçš„æ–¹æ³•">æ–¹æ³•ä¸€ï¼šåœ¨Componenté‡Œé¢å®šä¹‰ä¸€ä¸ªè¿”å›Dependencyçš„æ–¹æ³•</h4>
<p>ç¬¬ä¸€ç§æ˜¯åœ¨Componenté‡Œé¢å®šä¹‰ä¸€ä¸ªè¿”å›Dependencyçš„æ–¹æ³•ï¼Œæ¯”å¦‚LoginActivityéœ€è¦LoginPresenterï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨<code>AppComponent</code>é‡Œé¢å®šä¹‰ä¸€ä¸ªè¿”å›<code>LoginPresenter</code>çš„æ–¹æ³•ï¼š</p>

<pre><code class="language-java">@Component(modules = {AppModule.class})
public interface AppComponent {
    LoginPresenter loginPresenter();
}
</code></pre>

<p>ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆComponentåªéœ€è¦å®šä¹‰æˆæ¥å£å°±è¡Œäº†ï¼Œä¸æ˜¯åº”è¯¥å®šä¹‰ä¸€ä¸ªç±»ï¼Œç„¶åè‡ªå·±ä½¿ç”¨Moduleå»åšè¿™ä»¶äº‹å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£å°±å¤ªlowäº†ã€‚dagger2çš„å·¥ä½œåŸç†æ˜¯ï¼Œåœ¨ä½ çš„javaä»£ç ç¼–è¯‘æˆå­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œdagger2ä¼šå¯¹æ‰€æœ‰çš„Componentï¼ˆå°±æ˜¯ç”¨ <code>@Component</code>ä¿®é¥°è¿‡çš„interfaceï¼‰è¿›è¡Œå¤„ç†ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå®ç°äº†è¿™ä¸ªinterfaceçš„ç±»ï¼Œç”Ÿæˆçš„ç±»åæ˜¯Componentçš„åå­—å‰é¢åŠ ä¸Šâ€œDaggerâ€ã€‚æ¯”å¦‚æˆ‘ä»¬å®šä¹‰çš„ <code>AppComponent</code>ï¼Œå¯¹åº”çš„è‡ªåŠ¨ç”Ÿæˆçš„ç±»å«åš<code>DaggerAppComponent</code>ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå®ç°ä¸€ä¸ªinterfaceéœ€è¦å®ç°é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•ï¼Œå› æ­¤ï¼Œ<code>DaggerAppComponent</code>æ˜¯å®ç°äº† <code>loginPresenter();</code>è¿™ä¸ªæ–¹æ³•çš„ã€‚å®ç°çš„æ–¹å¼å¤§è‡´å°±æ˜¯ä» <code>AppComponent</code>ç®¡ç†çš„ <code>AppModule</code>é‡Œé¢å»æ‰¾<code>LoginPresenter</code>çš„Provideræ–¹æ³•ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª<code>LoginPresenter</code>ã€‚</p>

<p>å› æ­¤ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå½“Clientéœ€è¦Dependencyçš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦ç”¨<code>DaggerAppComponent</code>è¿™ä¸ªç±»åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ <code>loginPresenter()</code>æ–¹æ³•ï¼Œè¿™æ ·Clientå°±èƒ½è·å¾—ä¸€ä¸ª<code>LoginPresenter</code>äº†ï¼Œè¿™ä¸ª<code>DaggerAppComponent</code>å¯¹è±¡çš„åˆ›å»ºåŠä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">public class LoginActivity extends AppCompatActivity {
    private LoginPresenter mLoginPresenter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        AppComponent appComponent = DaggerAppComponent.builder().appModule(new AppModule(this)).build();  //&lt;=
        mLoginPresenter = appComponent.loginPresenter();   //&lt;=
    }
}
</code></pre>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œåšäº†ä»€ä¹ˆï¼š</p>

<ol>
  <li>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>AppModule</code>ç±»ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€äº›Provideræ–¹æ³•</li>
  <li>å®šä¹‰äº†ä¸€ä¸ª <code>AppComponent</code>ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªè¿”å›<code>LoginPresenter</code>çš„æ–¹æ³•<code>loginPresenter()</code>ã€‚</li>
</ol>

<p>å°±è¿™æ ·ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨ <code>DaggerAppComponent.builder().appModule(new AppModule(this)).build().loginPresenter();</code> æ¥è·å–ä¸€ä¸ª<code>LoginPresenter</code>å¯¹è±¡äº†ã€‚<br />
è¿™ç®€ç›´å°±æ˜¯magicï¼Œä¸æ˜¯å—ï¼Ÿ<br />
å¦‚æœä¸æ˜¯dagger2ï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå·±æ¥å®ç°è¿™ä¸ª<code>AppComponent</code> interfaceï¼Œæƒ³æƒ³æˆ‘ä»¬éœ€è¦åšå“ªäº›äº‹æƒ…ï¼š</p>

<ol>
  <li>å®šä¹‰ä¸€ä¸ªConstructorï¼Œæ¥å—ä¸€ä¸ª<code>AppModule</code>å¯¹è±¡ï¼Œä¿å­˜åœ¨fieldä¸­ï¼ˆmAppModule)</li>
  <li>å®ç°loginPresenter()æ–¹æ³•ï¼Œè°ƒç”¨mAppModuleçš„<code>provideLoginPresenter(UserManager userManager, PasswordValidator validator)</code>æ–¹æ³•ï¼Œè¿™æ—¶å€™å‘ç°è¿™ä¸ªæ–¹æ³•éœ€è¦ä¸¤ä¸ªå‚æ•° <code>UserManager</code>å’Œ<code>PasswordValidator</code>ã€‚</li>
  <li>è°ƒç”¨<code>provideUserManager(SharedPreferences preferences, UserApiService service)</code>æ¥è·å–ä¸€ä¸ª<code>UserManager</code>ï¼Œè¿™æ—¶å€™å‘ç°è¿™ä¸ªæ–¹æ³•åˆéœ€è¦ä¸¤ä¸ªå‚æ•° <code>SharedPreferences</code>å’Œ <code>UserApiService</code>ã€‚</li>
  <li>è°ƒç”¨<code>provideSharedPreferences(Context context)</code>æ¥è·å–ä¸€ä¸ªSharedPreferenceï¼Œè¿™æ—¶å€™å‘ç°å…ˆè¦æœ‰ä¸€ä¸ªcontext</li>
  <li>ã€‚ã€‚ã€‚</li>
  <li>ã€‚ã€‚ã€‚</li>
  <li>ã€‚ã€‚ã€‚</li>
</ol>

<p>è¯´ç™½äº†ï¼Œå°±æ˜¯æŠŠæ–‡ç« å¼€å¤´æˆ‘ä»¬å†™çš„é‚£æ®µä»£ç åˆå®ç°äº†ä¸€éï¼Œè€Œä½¿ç”¨dagger2ï¼Œæˆ‘ä»¬å°±åšäº†å‰é¢æè¿°çš„ä¸¤ä»¶äº‹è€Œå·²ï¼Œè¿™é‡Œé¢é”™ç»¼å¤æ‚çš„Dependencyå…³ç³»dagger2å¸®æˆ‘ä»¬è‡ªåŠ¨ç†æ¸…äº†ï¼Œç”Ÿæˆç›¸åº”çš„ä»£ç ï¼Œå»è°ƒç”¨ç›¸åº”çš„Provideræ–¹æ³•ï¼Œæ»¡è¶³è¿™äº›ä¾èµ–å…³ç³»ã€‚<br />
ä¹Ÿè®¸è¿™é‡Œä¸¾å¾—è¿™ä¸ªä¾‹å­ä¸è¶³ä»¥è®©ä½ è§‰å¾—æœ‰ä»€ä¹ˆå¤§ä¸äº†çš„ï¼Œä½†æ˜¯ä½ è¦çŸ¥é“ï¼Œä¸€ä¸ªæ­£å¸¸çš„Appï¼Œå¯ä¸ä»…ä»…æœ‰ä¸€ä¸ªLogin pageè€Œå·²ï¼Œç¨å¾®å¤§ç‚¹çš„Appï¼ŒDependencyéƒ½æœ‰å‡ ç™¾ç”šè‡³ä¸Šåƒä¸ªï¼Œå¯¹äºæœåŠ¡å™¨ç¨‹åºæ¥è¯´ï¼ŒDependencyåˆ™æ›´å¤šã€‚å¯¹äºè¿™ç‚¹ï¼Œå¤§å®¶å¯ä»¥å»çœ‹<a href="https://www.youtube.com/watch?v=oK_XtfXPkqw">Dagger2ä¸»è¦ä½œè€…çš„è¿™ä¸ªè§†é¢‘</a>ï¼Œä»–é‡Œé¢æåˆ°äº†Googleä¸€ä¸ªandroid appæœ‰3000è¡Œä»£ç ä¸“é—¨æ¥ç®¡ç†Dependencyï¼Œè€Œä¸€ä¸ªServer appç”šè‡³æœ‰10ä¸‡è¡Œè¿™æ ·çš„ä»£ç ã€‚è¿™ä¸ªæ—¶å€™è¦å»æ‰‹åŠ¨newè¿™äº›dependencyã€å¹¶ä¸”è¦ä»¥æ­£ç¡®çš„é¡ºåºnewå‡ºæ¥ï¼Œç®€ç›´ä¼šè¦äººå‘½ã€‚è€Œä¸”è®©é—®é¢˜æ›´åŠ æ£˜æ‰‹çš„æ˜¯ï¼Œéšç€appçš„æ¼”è¿›éœ€æ±‚çš„å˜æ›´ï¼ŒDependencyä¹‹é—´çš„å…³ç³»ä¹Ÿåœ¨åŠ¨æ€çš„å˜åŒ–ã€‚æ¯”å¦‚è¯´<code>UserManager</code>ä¸å†ä½¿ç”¨<code>SharedPreference</code>ï¼Œè€Œæ˜¯ä½¿ç”¨databaseï¼Œè¿™ä¸ªæ—¶å€™<code>UserManager</code>çš„æ„é€ å‡½æ•°é‡Œé¢å°‘äº†ä¸€ä¸ª<code>SharedPreferences</code>ï¼Œå¤šäº†ä¸€ä¸ª<code>DatabaseHelper</code>è¿™æ ·çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆå¦‚æœä½¿ç”¨æ­£å¸¸çš„æ–¹å¼ç®¡ç†Dependencyï¼Œæ‰€æœ‰<code>new UserManager</code>çš„åœ°æ–¹éƒ½è¦æ”¹ï¼Œè€Œæ˜¯ç”¨dagger2ï¼Œä½ åªéœ€è¦åœ¨ <code>AppModule</code>é‡Œé¢æ·»åŠ ä¸€ä¸ªDatabaseHelper Provideræ–¹æ³•ï¼ŒåŒæ—¶æŠŠ<code>UserManager</code>çš„provideræ–¹æ³•ç¬¬ä¸€å‚æ•°ä»<code>SharedPreferences</code>æ”¹æˆ<code>DatabaseHelper</code>å°±å¥½äº†ï¼Œæ‰€æœ‰ç”¨åˆ°<code>UserManager</code>çš„åœ°æ–¹ä¸éœ€è¦åšä»»ä½•æ›´æ”¹ï¼Œ<code>LoginPresenter</code>ä¸éœ€è¦åšä»»ä½•æ›´æ”¹ï¼Œ<code>LoginActivity</code>ä¸éœ€è¦ä»»ä½•æ›´æ”¹ï¼Œè¿™éš¾é“ä¸æ˜¯magicå—ï¼Ÿ</p>

<p>è¯´ç‚¹é¢˜å¤–è¯ï¼Œè¿™ç§æŠŠé—®é¢˜(æˆ‘ä»¬è¿™é‡Œæ˜¯ä¾èµ–å…³ç³»)æè¿°å‡ºæ¥ï¼Œè€Œä¸æ˜¯æŠŠå®ç°è¿‡ç¨‹å†™å‡ºæ¥çš„ç¼–ç¨‹é£æ ¼å«<a href="https://en.wikipedia.org/wiki/Declarative_programming">Declarative programming</a>ï¼Œè·Ÿå®ƒå¯¹åº”çš„å«<a href="https://en.wikipedia.org/wiki/Imperative_programming">Imperative Programming</a>ï¼Œç›¸å¯¹äºåè€…ï¼Œå‰è€…çš„ä¼˜åŠ¿æ˜¯ï¼šå¯è¯»æ€§æ›´é«˜ï¼Œside effectæ›´å°‘ï¼Œå¯æ‰©å±•æ€§æ›´é«˜ç­‰ç­‰ã€‚è¿™æ˜¯ä¸€ç§ç¼–ç¨‹é£æ ¼ï¼Œè·Ÿè¯­è¨€ã€æ¡†æ¶æ— å…³ã€‚å½“ç„¶ï¼Œæœ‰çš„è¯­è¨€æˆ–æ¡†æ¶å¤©ç”Ÿå°±èƒ½è®©ç¨‹åºå‘˜æ›´å®¹æ˜“çš„ä½¿ç”¨è¿™ç§styleæ¥ç¼–ç¨‹ã€‚è¿™æ–¹é¢æœ€æ˜¾è‘—çš„å½“å±<a href="https://en.wikipedia.org/wiki/Prolog">Prolog</a>ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»äº†è§£ä¸‹ï¼Œç»å¯¹mind-blowingï¼<br />
å¯¹äºJavaæˆ–Androidå¼€å‘è€…æ¥è¯´ï¼Œæƒ³è®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ declarativeï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨dagger2å’Œ<a href="https://github.com/ReactiveX/RxJava">RxJava</a>ã€‚</p>

<h4 id="æ–¹æ³•äºŒfield-injection">æ–¹æ³•äºŒï¼šField Injection</h4>
<p>è¯è¯´å›æ¥ï¼Œæˆ‘ä»¬ç»§ç»­ä»‹ç»dagger2ï¼Œå‰é¢æˆ‘ä»¬ä»‹ç»äº†Componentç»™Clientæä¾›Dependencyçš„ç¬¬ä¸€ç§æ–¹å¼ï¼Œæ¥ä¸‹æ¥ç»§ç»­ä»‹ç»ç¬¬äºŒç§æ–¹å¼ï¼Œè¿™ç§æ–¹å¼å« <em>Field injection</em> ã€‚è¿™é‡Œæˆ‘ä»¬ç»§ç»­ç”¨<code>LoginActivity</code>çš„ä¾‹å­æ¥è¯´æ˜ï¼Œ<code>LoginActivity</code>éœ€è¦ä¸€ä¸ª<code>LoginPresenter</code>ã€‚é‚£ä¹ˆä½¿ç”¨è¿™ç§æ–¹å¼çš„åšæ³•æ˜¯ï¼Œæˆ‘ä»¬å°±åœ¨<code>LoginActivity</code>é‡Œé¢å®šä¹‰ä¸€ä¸ª<code>LoginPresenter</code>çš„fieldï¼Œè¿™ä¸ªfieldéœ€è¦ä½¿ç”¨ <code>@Inject</code>ä¿®é¥°ä¸€ä¸‹ï¼š</p>

<pre><code class="language-java">public class LoginActivity extends AppCompatActivity {
    @Inject                             //&lt;=
    LoginPresenter mLoginPresenter;     //&lt;=

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }
}
</code></pre>

<p>ç„¶ååœ¨onCreate()é‡Œé¢ï¼Œæˆ‘ä»¬æŠŠ<code>DaggerAppComponent</code>å¯¹è±¡åˆ›å»ºå‡ºæ¥ï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„injectæ–¹æ³•ï¼ŒæŠŠ<code>LoginActivity</code>ä¼ è¿›å»ï¼š</p>

<pre><code class="language-java">public class LoginActivity extends AppCompatActivity {
    @Inject                             
    LoginPresenter mLoginPresenter;     

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        AppComponent appComponent = DaggerAppComponent.builder().appModule(new AppModule(this)).build(); //&lt;=
        appComponent.inject(this); //&lt;=

        //ä»æ­¤ä¹‹åï¼ŒmLoginPresenterå°±è¢«å®ä¾‹åŒ–äº†
        //mLoginPresenter.isLogin()
    }
}
</code></pre>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåœ¨<code>AppComponent</code>é‡Œé¢å®šä¹‰ä¸€ä¸ª<code>inject(LoginActivity loginActivity)</code>æ–¹æ³•ï¼š</p>

<pre><code class="language-java">@Component(modules = {AppModule.class})
public interface AppComponent {
    void inject(LoginActivity loginActivity);  //&lt;=
}
</code></pre>

<p><code>DaggerAppComponent</code>å®ç°è¿™ä¸ªæ–¹æ³•çš„æ–¹å¼æ˜¯ï¼Œå»<code>LoginActivity</code>é‡Œé¢æ‰€æœ‰è¢« <code>@Inject</code>ä¿®é¥°çš„fieldï¼Œç„¶åè°ƒç”¨ <code>AppModule</code>ç›¸åº”çš„Provideræ–¹æ³•ï¼Œèµ‹å€¼ç»™è¿™ä¸ªfieldã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>@Inject</code> fieldä¸èƒ½ä½¿privateï¼Œä¸ç„¶dagger2æ‰¾ä¸åˆ°è¿™ä¸ªfieldã€‚<br />
é€šå¸¸æ¥è¯´ï¼Œè¿™ç§æ–¹å¼æ¯”ç¬¬ä¸€ç§æ–¹å¼æ›´ç®€å•ï¼Œä»£ç ä¹Ÿæ›´ç®€æ´ã€‚å‡è®¾<code>LoginActivity</code>è¿˜éœ€è¦å…¶ä»–çš„Dependencyï¼Œæ¯”å¦‚éœ€è¦ä¸€ä¸ªç»Ÿè®¡æ‰“ç‚¹çš„Dependencyï¼ˆ<code>StatManager</code>ï¼‰ï¼Œé‚£ä¹ˆä½ åªéœ€è¦åœ¨<code>AppModule</code>é‡Œé¢å®šä¹‰ä¸€ä¸ªProvideræ–¹æ³•ï¼Œç„¶ååœ¨<code>LoginActivity</code>é‡Œé¢å£°æ˜å¦å¤–ä¸€ä¸ªfieldå°±å¥½äº†ï¼š</p>

<pre><code class="language-java">public class LoginActivity extends AppCompatActivity {
    @Inject                             
    LoginPresenter mLoginPresenter;  

    @Inject
    StatManager mStatManager;   //&lt;=

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        AppComponent appComponent = DaggerAppComponent.builder().appModule(new AppModule(this)).build();
        appComponent.inject(this);
    }
}
</code></pre>

<p>æ— è®ºæœ‰å¤šå°‘ä¸ª@Inject fieldï¼Œéƒ½åªéœ€è¦è°ƒç”¨ä¸€æ¬¡<code>appComponent.inject(this);</code>ã€‚ç”¨è¿‡äº†ä½ å°±ä¼šè§‰å¾—ï¼Œæ©ï¼Œå¥½çˆ½ï¼<br />
ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ç§æ–¹å¼ä¸æ”¯æŒç»§æ‰¿ï¼Œæ¯”å¦‚è¯´<code>LoginActivity</code>ç»§æ‰¿è‡ªä¸€ä¸ª <code>BaseActivity</code>ï¼Œè€Œ<code>@Inject
StatManager mStatManager;</code>æ˜¯æ”¾åœ¨<code>BaseActivity</code>é‡Œé¢çš„ï¼Œé‚£ä¹ˆåœ¨<code>LoginActivity</code>é‡Œé¢è°ƒç”¨ <code>appComponent.inject(this);</code>å¹¶ä¸ä¼šè®©<code>BaseActivity</code>é‡Œé¢çš„ <code>mStatManager</code>å¾—åˆ°å®ä¾‹åŒ–ï¼Œä½ å¿…é¡»åœ¨ <code>BaseActivity</code>é‡Œé¢ä¹Ÿè°ƒç”¨ä¸€æ¬¡<code>appComponent.inject(this);</code>ã€‚</p>

<h4 id="singletonå’Œconstructor-injection">@Singletonå’ŒConstructor Injection</h4>
<p>åˆ°è¿™é‡Œï¼ŒClientä»Componentè·å–Dependencyçš„ä¸¤ç§æ–¹å¼å°±ä»‹ç»å®Œæ¯•ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ¯æ¬¡Clientå‘Componentç´¢è¦ä¸€ä¸ªDependencyï¼ŒComponentéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡ºæ¥ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´èµ„æºçš„æµªè´¹ï¼Œæˆ–è€…è¯´å¾ˆå¤šæ—¶å€™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ¯”å¦‚è¯´ï¼Œ<code>SharedPreferences</code>ã€<code>UserManager</code>ã€<code>OkHttpClient</code>, <code>Retrofit</code>è¿™äº›éƒ½åªéœ€è¦ä¸€ä»½å°±å¥½äº†ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ªinstanceï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ç»™è¿™äº›Dependencyçš„Provideræ–¹æ³•åŠ ä¸Š@Singletonå°±å¥½äº†ã€‚å¦‚ï¼š</p>

<pre><code class="language-java">@Module
public class AppModule {

    @Provides
    @Singleton          //&lt;=
    public OkHttpClient provideOkHttpClient() {
        OkHttpClient okhttpClient = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .build();
        return okhttpClient;
    }

    //other method
}
</code></pre>

<p>è¿™æ ·ï¼Œå½“Clientç¬¬ä¸€æ¬¡è¯·æ±‚ä¸€ä¸ª<code>OkHttpClient</code>ï¼Œdagger2ä¼šåˆ›å»ºä¸€ä¸ªinstanceï¼Œç„¶åä¿å­˜ä¸‹æ¥ï¼Œä¸‹ä¸€æ¬¡Clientå†æ¬¡è¯·æ±‚ä¸€ä¸ª<code>OkHttpClient</code>æ˜¯ï¼Œdagger2ä¼šç›´æ¥è¿”å›ä¸Šæ¬¡åˆ›å»ºå¥½çš„ï¼Œè€Œä¸ç”¨å†æ¬¡åˆ›å»ºinstanceã€‚è¿™å°±ç›¸å½“äºç”¨ä¸€ç§æ›´ç®€ä¾¿ã€è€Œä¸”DI-ableçš„æ–¹å¼å®ç°äº†singletonæ¨¡å¼ã€‚</p>

<p>è¿™é‡Œå†ç»™å¤§å®¶ä¸€ä¸ªbonusï¼Œå¦‚æœä½ ä¸éœ€è¦åšå•å…ƒæµ‹è¯•ï¼Œè€Œåªæ˜¯ä½¿ç”¨dagger2æ¥åšDIï¼Œç»„ç»‡appçš„ç»“æ„çš„è¯ï¼Œå…¶å®<code>AppModule</code>é‡Œé¢çš„å¾ˆå¤šProvideræ–¹æ³•æ˜¯ä¸éœ€è¦å®šä¹‰çš„ã€‚æ¯”å¦‚è¯´åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>LoginPresenter</code>çš„Provideræ–¹æ³• ` provideLoginPresenter(UserManager userManager, PasswordValidator validator)<code> å°±ä¸éœ€è¦å®šä¹‰ï¼Œä½ åªéœ€è¦åœ¨å®šä¹‰</code>LoginPresenter<code>çš„æ—¶å€™ï¼Œç»™å®ƒçš„ConstructoråŠ ä¸Š </code>@Inject`ä¿®é¥°ä¸€ä¸‹ï¼š</p>

<pre><code class="language-java">public class LoginPresenter {
    private final UserManager mUserManager;
    private final PasswordValidator mPasswordValidator;

    @Inject
    public LoginPresenter(UserManager userManager, PasswordValidator passwordValidator) {
        this.mUserManager = userManager;
        this.mPasswordValidator = passwordValidator;
    }

    //other methods
}
</code></pre>

<p>dagger2ä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ª<code>LoginPresenter</code>æ‰€éœ€è¦çš„Dependencyæ˜¯å®ƒèƒ½å¤Ÿæä¾›çš„ï¼Œæ‰€ä»¥ä¼šå»Moduleé‡Œé¢æ‰¾åˆ°è¿™ä¸ª<code>LoginPresenter</code>æ‰€éœ€çš„Dependencyï¼Œäº¤ç»™<code>LoginPresenter</code>çš„Constructorï¼Œåˆ›å»ºå¥½è¿™Dependencyï¼Œäº¤ç»™Clientã€‚è¿™å…¶å®ä¹Ÿæ˜¯Clienté€šè¿‡Componentä½¿ç”¨Dependencyçš„ä¸€ç§æ–¹å¼ï¼Œå« <em>Constructor injection</em> ï¼ˆä¸Šä¸€ç¯‡æ–‡ç« ä¹Ÿæåˆ°<em>Constructor injection</em>ï¼Œä¸è¿‡ç¨å¾®æœ‰ç‚¹ä¸åŒï¼Œæ³¨æ„åŒºåˆ†ä¸€ä¸‹ï¼‰åŒæ ·çš„ï¼Œåœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œ<code>UserManager</code>çš„Provideræ–¹æ³•ä¹Ÿä¸éœ€è¦å®šä¹‰ï¼Œè€Œåªéœ€è¦ç»™<code>UserManager</code>çš„ConstructoråŠ ä¸Šä¸€ä¸ª<code>@Inject</code>å°±å¥½äº†ã€‚è¯´ç™½äº†ï¼Œä½ åªéœ€è¦ç»™é‚£äº›ä¸æ˜¯é€šè¿‡Constructoræ¥åˆ›å»ºçš„Dependencyï¼ˆæ¯”å¦‚è¯´SharedPreferencesã€UserApiServiceç­‰ï¼‰å®šä¹‰Provideræ–¹æ³•ã€‚<br />
æœ‰äº† <em>Constructor injection</em> ï¼Œæˆ‘ä»¬çš„ä»£ç åˆèƒ½å¾—åˆ°è¿›ä¸€æ­¥çš„ç®€åŒ–ï¼Œç„¶è€Œé—æ†¾çš„æ˜¯ï¼Œè¿™ç§æ–¹å¼å°†å¯¼è‡´æˆ‘ä»¬åšå•å…ƒæµ‹è¯•çš„æ—¶å€™æ— æ³•mockè¿™ä¸­é—´çš„Dependencyã€‚è¯´åˆ°å•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬åˆ«å¿˜äº†è¿™ä¸ªç³»åˆ—çš„ä¸»é¢˜T_Tã€‚ã€‚ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±ä»‹ç»dagger2åœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„ä½¿ç”¨ï¼Œä»¥åŠä¸ºä»€ä¹ˆ <em>Constructor injection</em> å°†å¯¼è‡´å•å…ƒæµ‹è¯•é‡Œé¢æ— æ³•mockè¿™ä¸ªDependencyã€‚</p>

<h2 id="dagger2åœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„ä½¿ç”¨">dagger2åœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„ä½¿ç”¨</h2>
<p>åœ¨ä»‹ç»dagger2åœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„ä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ”¹è¿›ä¸€ä¸‹å‰é¢çš„ä»£ç ï¼Œæˆ‘ä»¬åˆ›å»º<code>DaggerAppComponent</code>çš„åœ°æ–¹æ˜¯åœ¨<code>LoginActivity</code>ï¼Œå…¶å®è¿™æ ·ä¸æ˜¯å¾ˆå¥½ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæƒ³æƒ³å¦‚æœloginä»¥åå…¶ä»–åœ°æ–¹ä¹Ÿéœ€è¦<code>UserManager</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åˆè¦åˆ›å»ºä¸€ä¸ª<code>DaggerAppComponent</code>ï¼Œè¿™ç§åœ°æ–¹æ˜¯å¾ˆå¤šçš„ï¼Œæ¯•ç«Ÿ <code>AppModule</code>é‡Œé¢å®šä¹‰äº†ä¸€äº›æ•´ä¸ªappéƒ½è¦ç”¨åˆ°çš„Dependencyï¼Œæ¯”å¦‚è¯´Retrofitã€SharedPreferencesç­‰ç­‰ã€‚å¦‚æœæ¯ä¸ªéœ€è¦ç”¨åˆ°çš„åœ°æ–¹éƒ½åˆ›å»ºä¸€é<code>DaggerAppComponent</code>ï¼Œå°±å¯¼è‡´äº†ä»£ç çš„é‡å¤å’Œå†…å­˜æ€§èƒ½çš„æµªè´¹ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œ<code>DaggerAppComponent</code>å¯¹è±¡æ•´ä¸ªappåªéœ€è¦ä¸€ä»½å°±å¥½äº†ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ç”¨dagger2çš„æ—¶å€™ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯ï¼Œæˆ‘ä»¬ä¼šåœ¨appå¯åŠ¨çš„æ—¶å€™åˆ›å»ºå¥½ï¼Œæ”¾åœ¨æŸä¸€ä¸ªåœ°æ–¹ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰çš„Application#onCreate()é‡Œé¢åˆ›å»ºå¥½ï¼Œç„¶åæ”¾åœ¨æŸä¸ªåœ°æ–¹ï¼Œæˆ‘ä¸ªäººä¹ æƒ¯å®šä¹‰ä¸€ä¸ªç±»å«ComponentHolderï¼Œç„¶åæ”¾é‡Œé¢ï¼š</p>

<pre><code class="language-java">public class MyApplication extends Application {

    @Override
    public void onCreate() {
        super.onCreate();

        AppComponent appComponent = DaggerAppComponent.builder()
                                    .appModule(new AppModule(this))
                                    .build();
        ComponentHolder.setAppComponent(appComponent);
    }
}

public class ComponentHolder {
    private static AppComponent sAppComponent;

    public static void setAppComponent(AppComponent appComponent) {
        sAppComponent = appComponent;
    }

    public static AppComponent getAppComponent() {
        return sAppComponent;
    }
}
</code></pre>

<p>ç„¶ååœ¨éœ€è¦ <code>AppComponent</code>çš„åœ°æ–¹ï¼Œä½¿ç”¨ ComponentHolder.getAppComponent()æ¥è·å–ä¸€ä¸ª<code>DaggerAppComponent</code>å¯¹è±¡ï¼š</p>

<pre><code class="language-java">public class LoginActivity extends AppCompatActivity {
    @Inject
    LoginPresenter mLoginPresenter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        ComponentHolder.getAppComponent().inject(this);  //&lt;=
    }
}
</code></pre>

<p>è¿™æ ·åœ¨ç”¨çš„åœ°æ–¹ï¼Œçœ‹èµ·æ¥ä»£ç ä¹Ÿå¹²å‡€äº†å¾ˆå¤šã€‚<br />
åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»‹ç»åœ¨å•å…ƒæµ‹è¯•é‡Œé¢æ€ä¹ˆæ¥mock Dependencyäº†ã€‚å‡è®¾LoginActivityæœ‰ä¸¤ä¸ªEditTextå’Œä¸€ä¸ªlogin buttonï¼Œç‚¹å‡»è¿™ä¸ªbuttonï¼Œå°†ä»ä¸¤ä¸ªEditTexté‡Œé¢è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åè°ƒç”¨<code>LoginPresenter</code>çš„loginæ–¹æ³•ï¼š</p>

<pre><code class="language-java">public class LoginActivity extends AppCompatActivity {
    @Inject
    LoginPresenter mLoginPresenter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        ComponentHolder.getAppComponent().inject(this);

        findViewById(R.id.login).setOnClickListener(new OnClickListener() {
            @Override
            public void onClick(View v) {
                String username = ((EditText) findViewById(R.id.username)).getText().toString();
                String password = ((EditText) findViewById(R.id.password)).getText().toString();

                mLoginPresenter.login(username, password);
            }
        });
    }
}
</code></pre>

<p>æˆ‘ä»¬ç°åœ¨è¦æµ‹çš„ï¼Œå°±æ˜¯å½“ç”¨æˆ·ç‚¹å‡»è¿™ä¸ªlogin buttonçš„æ—¶å€™ï¼Œ<code>mLoginPresenter</code>çš„loginæ–¹æ³•å¾—åˆ°äº†è°ƒç”¨ï¼Œå¦‚æœä½ çœ‹äº†è¿™ä¸ªç³»åˆ—çš„å‰é¢å‡ ç¯‡æ–‡ç« ï¼Œä½ å°±çŸ¥é“è¿™é‡Œçš„<code>mLoginPresenter</code>éœ€è¦mockæ‰ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œçš„<code>mLoginPresenter</code>æ˜¯ä»dagger2çš„componenté‡Œé¢è·å–çš„ï¼Œè¿™é‡Œæ€ä¹ˆæŠŠ<code>mLoginPresenter</code>æ¢æˆmockå‘¢ï¼Ÿ<br />
æˆ‘ä»¬åœ¨å›é¡¾ä¸€ä¸‹ï¼Œå…¶å®<code>LoginActivity</code>åªæ˜¯å‘<code>DaggerAppComponent</code>ç´¢å–äº†ä¸€ä¸ª<code>LoginPresenter</code>ï¼Œè€Œ<code>DaggerAppComponent</code>å…¶å®æ˜¯è°ƒç”¨äº†<code>AppModule</code>çš„ <code>provideLoginPresenter()</code>æ–¹æ³•æ¥è·å¾—äº†ä¸€ä¸ª<code>LoginPresenter</code>ï¼Œè¿”å›ç»™<code>LoginActivity</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒçœŸæ­£ç”Ÿäº§<code>LoginPresenter</code>çš„åœ°æ–¹æ˜¯åœ¨ <code>AppModule</code>ã€‚è¿˜è®°å¾—å—ï¼Œæˆ‘ä»¬åˆ›å»º<code>DaggerAppComponent</code>çš„æ—¶å€™ï¼Œç»™å®ƒçš„builderä¼ é€’äº†ä¸€ä¸ª<code>AppModule</code>å¯¹è±¡ï¼š</p>

<pre><code class="language-java">public class MyApplication extends Application {

    @Override
    public void onCreate() {
        super.onCreate();

        AppComponent appComponent = DaggerAppComponent.builder()
                                    .appModule(new AppModule(this)) //&lt;= è¿™é‡Œè¿™é‡Œ
                                    .build();
        ComponentHolder.setAppComponent(appComponent);
    }
}
</code></pre>

<p>å…¶å®<code>DaggerAppComponent</code>è°ƒç”¨çš„<code>AppModule</code>å¯¹è±¡ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºå®ƒçš„æ—¶å€™ä¼ ç»™é‚£ä¸ªbuilderçš„ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬ä¼ ç»™<code>DaggerAppComponent</code>çš„<code>AppModule</code>æ˜¯ä¸€ä¸ªmockå¯¹è±¡ï¼Œåœ¨è¿™ä¸ªmockå¯¹è±¡çš„provideLoginPresenter()è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œè¿”å›ä¸€ä¸ªmockçš„<code>LoginPresenter</code>ï¼Œé‚£ä¹ˆ<code>LoginActivity</code>è·å¾—çš„ï¼Œä¸å°±æ˜¯ä¸€ä¸ªmockçš„<code>LoginPresenter</code>äº†å—ï¼Ÿ<br />
æˆ‘ä»¬ç”¨ä»£ç æ¥å®ç°ä¸€ä¸‹çœ‹çœ‹æ˜¯ä»€ä¹ˆæ ·å­ï¼Œè¿™é‡Œå› ä¸º<code>LoginActivity</code>æ˜¯androidç›¸å…³çš„ç±»ï¼Œå› æ­¤éœ€è¦ç”¨åˆ°robolectricè¿™ä¸ªframeworkï¼Œè™½ç„¶è¿™ä¸ªæˆ‘ä»¬è¿˜æ²¡æœ‰ä»‹ç»åˆ°ï¼Œä½†æ˜¯ä»£ç åº”è¯¥çœ‹å¾—æ‡‚ï¼Œå¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">@RunWith(RobolectricGradleTestRunner.class) //Robolectricç›¸å…³ï¼Œçœ‹ä¸æ‡‚çš„è¯å¿½ç•¥
@Config(constants = BuildConfig.class, sdk = 21) //åŒä¸Š
public class LoginActivityTest {

    @Test
    public void testActivityStart() {
        @Test
        public void testActivityStart() {
            AppModule mockAppModule = spy(new AppModule(RuntimeEnvironment.application)); //åˆ›å»ºä¸€ä¸ªmockAppModuleï¼Œè¿™é‡Œä¸èƒ½spy(AppModule.class)ï¼Œå› ä¸º`AppModule`æ²¡æœ‰é»˜è®¤æ— å‚æ•°çš„Constructorï¼Œä¹Ÿä¸èƒ½mock(AppModule.class),åŸå› æ˜¯dagger2çš„çº¦æŸï¼ŒProvideræ–¹æ³•ä¸èƒ½è¿”å›nullï¼Œé™¤éç”¨@Nullableä¿®é¥°
            LoginPresenter mockLoginPresenter = mock(LoginPresenter.class);  //åˆ›å»ºä¸€ä¸ªmockLoginPresenter
            Mockito.when(mockAppModule.provideLoginPresenter(any(UserManager.class), any(PasswordValidator.class))).thenReturn(mockLoginPresenter);  //å½“mockAppModuleçš„provideLoginPresenter()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè®©å®ƒè¿”å›mockLoginPresenter
            AppComponent appComponent = DaggerAppComponent.builder().appModule(mockAppModule).build();  //ç”¨mockAppModuleæ¥åˆ›å»ºDaggerAppComponent
            ComponentHolder.setAppComponent(appComponent);  //è®°å¾—æ”¾åˆ°ComponentHolderé‡Œé¢ï¼Œè¿™æ ·LoginActivity#onCreate()é‡Œé¢é€šè¿‡ComponentHolder.getAppComponent()è·å¾—çš„å°±æ˜¯è¿™é‡Œåˆ›å»ºçš„appComponent

            LoginActivity loginActivity = Robolectric.setupActivity(LoginActivity.class); //å¯åŠ¨LoginActivityï¼ŒonCreateæ–¹æ³•ä¼šå¾—åˆ°è°ƒç”¨ï¼Œé‡Œé¢çš„mLoginPresenteré€šè¿‡dagger2è·å¾—çš„ï¼Œå°†æ˜¯mockLoginPresenter
            ((EditText) loginActivity.findViewById(R.id.username)).setText("xiaochuang");
            ((EditText) loginActivity.findViewById(R.id.password)).setText("xiaochuang is handsome");
            loginActivity.findViewById(R.id.login).performClick();    

            verify(mockLoginPresenter).login("xiaochuang", "xiaochuang is handsome");  //pass!
        }
    }
}
</code></pre>

<p>è¿™å°±æ˜¯dagger2åœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„åº”ç”¨ã€‚åŸºæœ¬ä¸Šå°±æ˜¯mock Moduleçš„Provideræ–¹æ³•ï¼Œè®©å®ƒè¿”å›ä½ æƒ³è¦çš„mockå¯¹è±¡ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆè¯´åªç”¨ <em>Constructor injection</em> çš„è¯ï¼Œä¼šå¯¼è‡´Dependencyæ— æ³•mockï¼Œå› ä¸ºæ²¡æœ‰å¯¹åº”çš„Provideræ–¹æ³•æ¥è®©æˆ‘ä»¬mockå•Šã€‚ä¸Šé¢çš„ä»£ç çœ‹èµ·æ¥ä¹Ÿè®¸ä½ ä¼šè§‰å¾—æœ‰ç‚¹å¤šï¼Œç„¶è€Œå®é™…å¼€å‘ä¸­ï¼Œä¸Šé¢æµ‹è¯•æ–¹æ³•é‡Œçš„ç¬¬1ã€4ã€5è¡Œéƒ½æ˜¯é€šç”¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»–ä»¬æŠ½åˆ°ä¸€ä¸ªè¾…åŠ©ç±»é‡Œé¢ï¼š</p>

<pre><code class="language-java">public class TestUtils {
   public static final AppModule appModule = spy(new AppModule(RuntimeEnvironment.application));

   public static void setupDagger() {
       AppComponent appComponent = DaggerAppComponent.builder().appModule(appModule).build();
       ComponentHolder.setAppComponent(appComponent);
   }
}
</code></pre>

<p>è¿™æ ·æˆ‘ä»¬å‰é¢çš„æµ‹è¯•æ–¹æ³•å°±å¯ä»¥ç®€åŒ–äº†ï¼š</p>

<pre><code class="language-java">public class LoginActivityTest {

    @Test
    public void testActivityStart() {
        TestUtils.setupDagger();
        LoginPresenter mockLoginPresenter = mock(LoginPresenter.class);
        Mockito.when(TestUtils.appModule.provideLoginPresenter(any(UserManager.class), any(PasswordValidator.class))).thenReturn(mockLoginPresenter);

        LoginActivity loginActivity = Robolectric.setupActivity(LoginActivity.class);
        ((EditText) loginActivity.findViewById(R.id.username)).setText("xiaochuang");
        ((EditText) loginActivity.findViewById(R.id.password)).setText("xiaochuang is handsome");
        loginActivity.findViewById(R.id.login).performClick();

        verify(mockLoginPresenter).login("xiaochuang", "xiaochuang is handsome");
    }
}
</code></pre>

<p>å½“ç„¶ï¼Œä¸Šé¢çš„ä»£ç è¿˜å¯ä»¥ç”¨å¾ˆå¤šç§æ–¹æ³•ä½œè¿›ä¸€æ­¥ç®€åŒ–ï¼Œæ¯”å¦‚æŠŠ<code>TestUtils.setupDagger();</code>æ”¾åˆ°<code>@Before</code>é‡Œé¢ï¼Œæˆ–è€…æ˜¯è‡ªå®šä¹‰ä¸€ä¸ªåŸºç¡€æµ‹è¯•ç±»ï¼ŒæŠŠ<code>TestUtils.setupDagger();</code>æ”¾è¿™ä¸ªåŸºç¡€æµ‹è¯•ç±»çš„<code>@Before</code>é‡Œé¢ï¼Œç„¶å <code>LoginActivityTest</code>ç»§æ‰¿è¿™ä¸ªåŸºç¡€æµ‹è¯•ç±»å°±å¯ä»¥äº†ï¼Œor even betterï¼Œè‡ªå®šä¹‰ä¸€ä¸ªJUnit Ruleï¼Œåœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰è‡ªåŠ¨è°ƒç”¨ <code>TestUtils.setupDagger();</code>ã€‚åªæ˜¯è¿™äº›ä¸å½“å‰çš„ä¸»é¢˜æ— å…³ï¼Œå°±ä¸å…·ä½“å±•å¼€å™è¿°äº†ã€‚åé¢ä¼šè®²åˆ°<a href="https://github.com/fabioCollini/DaggerMock">DaggerMock</a>çš„ä½¿ç”¨ï¼Œè¿™ä¸ªä¸œè¥¿å¯çœŸçš„æ˜¯ç¥å™¨å•Šï¼ç®€ç›´ä¸è¦å¤ªç¥å™¨ï¼</p>

<p>###å•å…ƒæµ‹è¯•é‡Œé¢ï¼Œä¸è¦æ»¥ç”¨dagger2
è¿™é‡Œå†é‡å¤ä¸€ä¸‹ä¸Šä¸€ç¯‡æ–‡ç« çš„è¯ï¼Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ä¸è¦æ»¥ç”¨dagger2ï¼Œè™½ç„¶ç°åœ¨æˆ‘ä»¬çš„appæ˜¯ç”¨dagger2æ¶æ„èµ·æ¥çš„ï¼Œæ‰€æœ‰çš„Dependencyéƒ½æ˜¯åœ¨Moduleé‡Œé¢ç”Ÿäº§ï¼Œä½†å¹¶ä¸ä»£è¡¨æˆ‘ä»¬åœ¨åšå•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œè¿™äº›Dependencyä¹Ÿåªèƒ½åœ¨Moduleé‡Œé¢ç”Ÿäº§ã€‚æ¯”å¦‚è¯´ï¼Œ<code>LoginPresenter</code>ï¼š</p>

<pre><code class="language-java">public class LoginPresenter {
    private final UserManager mUserManager;
    private final PasswordValidator mPasswordValidator;

    @Inject
    public LoginPresenter(UserManager userManager, PasswordValidator passwordValidator) {
        this.mUserManager = userManager;
        this.mPasswordValidator = passwordValidator;
    }

    public void login(String username, String password) {
        if (username == null || username.length() == 0) return;
        if (mPasswordValidator.verifyPassword(password)) return;

        mUserManager.performLogin(username, password);
    }
}
</code></pre>

<p>æˆ‘ä»¬è¦æµ‹çš„æ˜¯ï¼Œ<code>LoginPresenter#login()</code>è°ƒç”¨äº† <code>mUserManager.performLogin()</code>ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸Šé¢çš„æ€è·¯ï¼Œä½¿ç”¨dagger2æ¥mock <code>UserManager</code>ï¼Œåšæ³•æ˜¯mock module çš„<code>provideUserManager()</code>æ–¹æ³•ï¼Œè®©å®ƒè¿”å›ä¸€ä¸ªmockçš„ <code>UserManager</code>ï¼Œç„¶åå»verifyè¿™ä¸ªmock <code>UserManager</code>çš„<code>performLogin()</code>æ–¹æ³•å¾—åˆ°äº†è°ƒç”¨ï¼Œä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">@RunWith(RobolectricGradleTestRunner.class)
@Config(constants = BuildConfig.class, sdk = 21)
public class LoginPresenterTest {

    @Test
    public void testLogin() throws Exception {
        TestUtils.setupDagger();
        UserManager mockUserManager = mock(UserManager.class);
        Mockito.when(TestUtils.appModule.provideUserManager(any(SharedPreferences.class), any(UserApiService.class))).thenReturn(mockUserManager);

        LoginPresenter presenter = ComponentHolder.getAppComponent().loginPresenter();
        presenter.login("xiaochuang", "xiaochuang is handsome");

        verify(mockUserManager).performLogin("xiaochuang", "xiaochuang is handsome");
    }
}
</code></pre>

<p>è¿™æ ·è™½ç„¶å¯ä»¥ï¼Œè€Œä¸”ä¹Ÿä¸éš¾ï¼Œä½†æ¯•ç«Ÿè·¯ç»•çš„æœ‰ç‚¹è¿œï¼Œè€Œä¸”ä½ å¯èƒ½è¦åšé¢å¤–çš„ä¸€äº›å·¥ä½œï¼Œæ¯”å¦‚åœ¨<code>AppComponent</code>é‡Œé¢åŠ ä¸€ä¸ªæ­£å¼ä»£ç ä¸ä¸€å®šä¼šç”¨çš„ <code>loginPresenter();</code>æ–¹æ³•ï¼Œå¦å¤–å› ä¸º<code>AppModule</code>é‡Œé¢æœ‰å®‰å“ç›¸å…³çš„ä»£ç ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»ä½¿ç”¨Robolectricï¼Œå¯¼è‡´æµ‹è¯•è·‘èµ·æ¥æ…¢äº†å¾ˆå¤šã€‚å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥ä¸ç”¨dagger2ï¼Œæœ‰æ›´å¥½çš„åŠæ³•ï¼Œé‚£å°±æ˜¯ç›´æ¥new <code>LoginPresenter</code>ï¼Œä¼ å…¥mock <code>UserManager</code>ï¼š</p>

<pre><code class="language-java">public class LoginPresenterTest {
    @Test
    public void testLogin() {
        UserManager mockUserManager = mock(UserManager.class);
        LoginPresenter presenter = new LoginPresenter(mockUserManager, new PasswordValidator()); //å› ä¸ºè¿™é‡Œæˆ‘ä»¬ä¸verify PasswordValidatorï¼Œæ‰€ä»¥ä¸éœ€è¦mockè¿™ä¸ªã€‚

        presenter.login("xiaochuang", "xiaochuang is handsome");

        verify(mockUserManager).performLogin("xiaochuang", "xiaochuang is handsome");
    }
}
</code></pre>

<p>ç¨‹åºæ˜¯ä¸æ˜¯ç®€å•å¤šäº†ï¼Œä¹Ÿå®¹æ˜“ç†è§£å¤šäº†ï¼Ÿ<br />
é‚£ä¹ˆç°åœ¨é—®é¢˜æ¥äº†ï¼Œå¦‚æœè¿™æ ·çš„è¯ï¼Œå•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå“ªäº›æƒ…å†µåº”è¯¥ç”¨dagger2ï¼Œé‚£äº›æƒ…å†µä¸ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œèƒ½ä¸ç”¨dagger2ï¼Œå°±ä¸ç”¨dagger2ï¼Œä¸å¾—å·²ç”¨dagger2ï¼Œæ‰ç”¨dagger2ã€‚å½“ç„¶ï¼Œè¿™æ˜¯ä¸€å¥åºŸè¯ï¼Œå‰é¢æˆ‘ä»¬å·²ç»æ˜æ˜¾æ„Ÿå—åˆ°äº†ï¼Œåœ¨å•å…ƒæµ‹è¯•é‡Œé¢ç”¨dagger2æ¯”ä¸ç”¨dagger2è¦éº»çƒ¦å¤šäº†ï¼Œèƒ½ä¸ç”¨å½“ç„¶ä¸ç”¨ã€‚é‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†ï¼Œä»€ä¹ˆæƒ…å†µä¸‹å¿…é¡»ç”¨dagger2ã€è€Œä»€ä¹ˆæ—¶å€™å¯ä»¥ä¸ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå¦‚æœè¢«æµ‹ç±»ï¼ˆæ¯”å¦‚è¯´<code>LoginActivity</code>ï¼‰çš„Dependencyï¼ˆ<code>LoginPresenter</code>ï¼‰æ˜¯é€šè¿‡ <em>field injection</em> injectè¿›å»çš„ï¼Œé‚£ä¹ˆå†æµ‹è¿™ä¸ªç±»ï¼ˆ<code>LoginActivity</code>ï¼‰çš„æ—¶å€™ï¼Œå°±å¿…é¡»ç”¨dagger2ï¼Œä¸ç„¶å¾ˆéš¾ä¼˜é›…çš„æŠŠmockä¼ è¿›å»ã€‚ç›¸åï¼Œå¦‚æœè¢«æµ‹ç±»æœ‰Constructorï¼ˆæ¯”å¦‚è¯´<code>LoginPresenter</code>ï¼‰ï¼ŒDependencyæ˜¯é€šè¿‡Constructorä¼ è¿›å»çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¸ä½¿ç”¨dagger2ï¼Œè€Œæ˜¯ç›´æ¥newå¯¹è±¡å‡ºæ¥æµ‹ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘åœ¨å‰ä¸€ç¯‡æ–‡ç« é‡Œé¢å¼ºçƒˆçš„æ¨è Constructor Injectionçš„åŸå› ã€‚</p>

<h2 id="å°ç»“">å°ç»“</h2>
<p>è¿™ç¯‡æ–‡ç« ä»‹ç»äº†dagger2çš„ä½¿ç”¨ï¼Œä»¥åŠåœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„åº”ç”¨ã€‚å“¦å¥½åƒå¿˜äº†ä»‹ç»æŠŠdagger2åŠ åˆ°é¡¹ç›®é‡Œé¢çš„æ–¹æ³•ï¼Œå…¶å®å¾ˆç®€å•ï¼ŒæŠŠä»¥ä¸‹ä»£ç åŠ å…¥build.gradleï¼š</p>

<pre><code class="language-groovy">buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'com.neenbedankt.gradle.plugins:android-apt:1.8'
    }
}

apply plugin: 'com.android.application'  //è¿™ä¸ªå·²ç»æœ‰äº†ï¼Œè¿™é‡Œåªæ˜¯æƒ³è¯´æ˜è¦æŠŠandroid-aptè¿™ä¸ªpluginæ”¾åˆ°è¿™ä¸ªçš„åé¢ã€‚
apply plugin: 'com.neenbedankt.android-apt'

dependencies {
    //other dependencies

    //Dagger2
    compile 'com.google.dagger:dagger:2.0.2'
    compile 'javax.annotation:jsr250-api:1.0'
    apt 'com.google.dagger:dagger-compiler:2.0.2'
}
</code></pre>

<p>åº”è¯¥è¯´ï¼ŒDIæ˜¯ä¸€ç§å¾ˆå¥½çš„æ¨¡å¼ï¼Œå“ªæ€•ä¸åšå•å…ƒæµ‹è¯•ï¼ŒDIä¹Ÿä¼šè®©æˆ‘ä»¬çš„appçš„æ¶æ„å˜å¾—å¹²å‡€å¾ˆå¤šï¼Œå¯è¯»æ€§ã€ç»´æŠ¤æ€§å’Œå¯æ‹“å±•æ€§å¼ºå¾ˆå¤šï¼Œåªä¸è¿‡å•å…ƒæµ‹è¯•è®©DIçš„å¿…è¦æ€§å˜å¾—æ›´åŠ æ˜¾è‘—å’Œè¿«åˆ‡è€Œå·²ã€‚è€Œdagger2çš„ä½œç”¨ï¼Œæˆ–è€…è¯´è§’è‰²ï¼Œåœ¨äºå®ƒè®©æˆ‘ä»¬å†™æ­£å¼ä»£ç çš„æ—¶å€™ä½¿ç”¨DIå˜å¾—æ˜“å¦‚åæŒï¼Œç¨‹åºåŠå…¶ç®€æ´ä¼˜é›…å¯è¯»æ€§é«˜ã€‚åŒæ—¶ï¼Œå®ƒåœ¨æŸäº›æƒ…å†µä¸‹è®©åŸæ¥å¾ˆéš¾æµ‹çš„ä»£ç å˜å¾—ç”¨ä»¥æµ‹è¯•ã€‚</p>

<p>æ–‡ä¸­çš„ä»£ç åœ¨<a href="https://github.com/ChrisZou/android-unit-testing-tutorial">githubè¿™ä¸ªé¡¹ç›®é‡Œé¢</a>ã€‚<br />
æœ€åï¼Œå¦‚æœä½ å¯¹å®‰å“å•å…ƒæµ‹è¯•æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„äº¤æµç¾¤ï¼Œå› ä¸ºç¾¤æˆå‘˜è¶…è¿‡100äººï¼Œæ²¡åŠæ³•æ‰«ç åŠ å…¥ï¼Œè¯·å…³æ³¨ä¸‹æ–¹å…¬ä¼—å·è·å–åŠ å…¥æ–¹æ³•ã€‚</p>

<p>å‚è€ƒï¼šhttps://www.youtube.com/watch?v=oK_XtfXPkqw</p>
:ET