I"'<h2 id="the-old-way">The Old Way</h2>
<p>æˆ‘ä»¬åœ¨ç³»åˆ—çš„ç¬¬å…­ç¯‡æ–‡ç« å‰é¢ä»‹ç»äº†<a href="http://chriszou.com/2016/05/10/android-unit-testing-di-dagger.html">Dagger2åœ¨å•å…ƒæµ‹è¯•é‡Œé¢çš„ä½¿ç”¨å§¿åŠ¿</a>ã€‚å¤§è‡´è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆï¼Œä½ è¦mockå‡ºä¸€ä¸ªModuleï¼Œè®©å®ƒçš„æŸä¸ªProvideræ–¹æ³•åœ¨è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œè¿”å›ä½ æƒ³åˆ°çš„mockçš„Dependencyã€‚ç„¶åä½¿ç”¨è¿™ä¸ªmockçš„moduleæ¥buildå‡ºä¸€ä¸ªComponentï¼Œå†æŠŠè¿™ä¸ªComponentæ”¾åˆ°ä½ çš„<code>ComponentHolder</code>ã€‚ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ª<code>LoginActivity</code>ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª<code>LoginPresenter</code>ï¼Œæ˜¯é€šè¿‡Dagger2 injectè¿›å»çš„ï¼Œå¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">public class LoginActivity extends AppCompatActivity {
    @Inject
    LoginPresenter mLoginPresenter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        //...other code
        
        ComponentHolder.getAppComponent().inject(this);
    }
}

//å¯¹åº”çš„Testç±»å¦‚ä¸‹ï¼š

@RunWith(RobolectricGradleTestRunner.class)
@Config(constants = BuildConfig.class, sdk = 21)
public class LoginActivityTest {
    @Test
    public void testLogin() {
        AppModule mockAppModule = Mockito.mock(AppModule.class);
        LoginPresenter mockLoginPresenter = mock(LoginPresenter.class);
        Mockito.when(mockAppModule.provideLoginPresenter(any(UserManager.class), any(PasswordValidator.class))).thenReturn(mockLoginPresenter);  //å½“mockAppModuleçš„provideLoginPresenter()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè®©å®ƒè¿”å›mockLoginPresenter
        AppComponent appComponent = DaggerAppComponent.builder().appModule(mockAppModule).build();  //ç”¨mockAppModuleæ¥åˆ›å»ºDaggerAppComponent
        ComponentHolder.setAppComponent(appComponent);  //å‡è®¾ä½ çš„Componentæ˜¯æ”¾åœ¨ComponentHolderé‡Œé¢çš„

        LoginActivity loginActivity = Robolectric.setupActivity(LoginActivity.class);
        ((EditText) loginActivity.findViewById(R.id.username)).setText("xiaochuang");
        ((EditText) loginActivity.findViewById(R.id.password)).setText("xiaochuang is handsome");
        loginActivity.findViewById(R.id.login).performClick();    

        verify(mockLoginPresenter).login("xiaochuang", "xiaochuang is handsome");
    }
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†è®©Dagger2è¿”å›ä¸€ä¸ªMockå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦å†™5è¡Œä»£ç ã€‚å†å¤šå†™å‡ ä¸ªæµ‹è¯•ï¼Œæˆ‘ä¿è¯ä½ ä¸€å®šä¼šè§‰å¾—ç¹ççš„ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a href="http://chriszou.com/2016/07/16/mockito-annotation.html">å‰ä¸€ç¯‡æ–‡ç« </a>é‡Œé¢è¯´çš„æ–¹å¼ï¼Œå’Œå…¶å®ƒçš„ä¸€äº›æ‰‹æ®µï¼Œæ¥ç®€åŒ–ä»£ç ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä½œå‡ºçš„ä¸€äº›åŠªåŠ›ï¼Œåº”è¯¥è¯´ï¼Œä»£ç å·²ç»æ¯”è¾ƒç®€æ´äº†ï¼š</p>

<pre><code class="language-java">@RunWith(RobolectricGradleTestRunner.class)
@Config(constants = BuildConfig.class, sdk = 21)
public class LoginActivityTest {

    @Rule
    public MockitoRule mockitoRule = MockitoJUnit.rule();

    @Mock
    LoginPresenter loginPresenter;

    @Test
    public void testLogin() {
        Mockito.when(TestUtils.appModule.provideLoginPresenter(any(UserManager.class), any(PasswordValidator.class))).thenReturn(loginPresenter);  //å½“mockAppModuleçš„provideLoginPresenter()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè®©å®ƒè¿”å›mockLoginPresenter
        TestUtils.setupDagger();

        LoginActivity loginActivity = Robolectric.setupActivity(LoginActivity.class);
        ((EditText) loginActivity.findViewById(R.id.username)).setText("xiaochuang");
        ((EditText) loginActivity.findViewById(R.id.password)).setText("xiaochuang is handsome");
        loginActivity.findViewById(R.id.login).performClick();

        verify(loginPresenter).login("xiaochuang", "xiaochuang is handsome");
    }

}

public class TestUtils {
    public static final AppModule appModule = spy(new AppModule(RuntimeEnvironment.application));
    public static void setupDagger() {
        AppComponent appComponent = DaggerAppComponent.builder().appModule(appModule).build();
        ComponentHolder.setAppComponent(appComponent);
    }
}
</code></pre>

<p>ä¸Šé¢æŠŠdaggerè®¾ç½®ç›¸å…³çš„ä»£ç å‡å°‘åˆ°äº†ä¸¤è¡Œï¼Œåº”è¯¥è¯´ï¼Œå·²ç»ä¸å†æ˜¯ä¸€ä¸ªè´Ÿæ‹…äº†ã€‚ç„¶è€Œå“ªæ€•æ˜¯è¿™æ ·ï¼Œå¦‚æœå†™å¤šäº†çš„è¯ï¼Œä¾ç„¶ä¼šè®©äººæ„Ÿè§‰ç•¥çƒ¦ï¼Œå› ä¸ºè¿™ä¹Ÿå®Œå…¨æ˜¯Boilerplate codeï¼ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨â€œä¹Ÿâ€ï¼Ÿï¼‰ã€‚å†å¤šå†™ä¸€ç‚¹ï¼Œä½ å°±ä¼šè‡ªç„¶è€Œç„¶çš„æƒ³ï¼Œå¦‚æœèƒ½æœ‰ä¸€ä¸ªå·¥å…·ï¼Œèƒ½è¾¾åˆ°è¿™æ ·çš„æ•ˆæœå°±å¥½äº†ï¼šæˆ‘ä»¬åœ¨Testç±»é‡Œé¢å®šä¹‰ä¸€ä¸ª@Mock fieldï¼ˆæ¯”å¦‚ä¸Šé¢çš„<code>loginPresenter</code>ï¼‰ï¼Œè¿™ä¸ªå·¥å…·å°±èƒ½è‡ªåŠ¨æŠŠè¿™ä¸ªfieldä½œä¸ºdaggerçš„moduleå¯¹åº”çš„provideræ–¹æ³•ï¼ˆ<code>provideLoginPresenter(...)</code>ï¼‰çš„è¿”å›å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡ªåŠ¨çš„mock moduleï¼Œè®©å®ƒè¿”å›è¿™ä¸ª@Mock fieldï¼Œç„¶åç”¨è¿™ä¸ªmockçš„moduleæ¥buildä¸€ä¸ªcomponentï¼Œå¹¶æ”¾åˆ°ComponentHolderé‡Œé¢å»ã€‚</p>

<h2 id="new-hope">New Hope</h2>
<p>Wellï¼Œæˆ‘å†™è¿™ç¯‡æ–‡ç« ï¼Œå°±æ˜¯æƒ³å‘Šè¯‰å¤§å®¶ï¼Œè¿˜çœŸæœ‰äººå†™äº†è¿™æ ·çš„ä¸€ä¸ªå·¥å…·ï¼Œè¿™å°±æ˜¯è¿™ç¯‡æ–‡ç« è¦ä»‹ç»çš„<a href="https://github.com/fabioCollini/DaggerMock">DaggerMock</a>ã€‚å®ƒå°±èƒ½è¾¾åˆ°æˆ‘ä»¬ä¸Šé¢æè¿°çš„é‚£ç§æ•ˆæœï¼Œè®©æˆ‘ä»¬åƒä½¿ç”¨Mockito Annotationä¸€æ ·æ¥å®šä¹‰Mockï¼Œå´èƒ½è‡ªåŠ¨æŠŠå®ƒä»¬ä½œä¸ºDagger2ç”Ÿäº§çš„Dependencyã€‚è¾¾åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š</p>

<pre><code class="language-java">@RunWith(RobolectricGradleTestRunner.class)
@Config(constants = BuildConfig.class, sdk = 21)
public class LoginActivityTest {

    @Rule public DaggerRule daggerRule = new DaggerRule();

    @Mock
    LoginPresenter loginPresenter;

    @Test
    public void testLogin_shinny_way() {
        LoginActivity loginActivity = Robolectric.setupActivity(LoginActivity.class);
        ((EditText) loginActivity.findViewById(R.id.username)).setText("xiaochuang");
        ((EditText) loginActivity.findViewById(R.id.password)).setText("xiaochuang is handsome");
        loginActivity.findViewById(R.id.login).performClick();

        verify(loginPresenter).login("xiaochuang", "xiaochuang is handsome");
    }
}
</code></pre>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå·²ç»æ²¡æœ‰å¤šä½™çš„Boilerplate codeï¼Œè¦å†™çš„ä»£ç ï¼ŒåŸºæœ¬æ˜¯å¿…éœ€å†™çš„äº†ã€‚ä¸Šé¢èµ·ä½œç”¨çš„æ˜¯<code>@Rule public DaggerRule daggerRule = new DaggerRule();</code> è¿™è¡Œä»£ç ã€‚å¯è§ï¼Œå®ƒæ˜¯é€šè¿‡JUnit Ruleæ¥å®ç°çš„ã€‚å¦‚æœä½ ç†Ÿæ‚‰<a href="http://chriszou.com/2016/07/09/junit-rule.html">JUnit Ruleçš„å·¥ä½œåŸç†</a>ï¼Œé‚£ä¹ˆä½ å¾ˆå®¹æ˜“çŒœåˆ°è¿™ä¸ª<code>DaggerRule</code>çš„å·¥ä½œåŸç†ï¼š</p>

<ol>
  <li>åˆå§‹åŒ–ä¸€ä¸ªæµ‹è¯•ç±»é‡Œé¢çš„æ‰€æœ‰ç”¨<code>@Mock</code> fieldä¸ºmockå¯¹è±¡(<code>loginPresenter</code>)</li>
  <li>mock <code>AppModule</code>ï¼Œé€šè¿‡åå°„çš„æ–¹å¼å¾—åˆ°<code>AppModule</code>çš„æ‰€æœ‰provideræ–¹æ³•ï¼Œå¦‚æœæœ‰æŸä¸ªæ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª<code>LoginPresenter</code>ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨Mockitoï¼Œè®©è¿™ä¸ªæ–¹æ³•ï¼ˆ<code>provideLoginPresenter(...)</code>)è¢«è°ƒç”¨æ—¶ï¼Œè¿”å›æˆ‘ä»¬åœ¨æµ‹è¯•ç±»é‡Œé¢å®šä¹‰çš„mock <code>loginPresenter</code>ã€‚</li>
  <li>ä½¿ç”¨è¿™ä¸ªmock AppModuleæ¥æ„å»ºä¸€ä¸ªComponentï¼Œå¹¶ä¸”æ”¾åˆ°<code>ComponentHolder</code>é‡Œé¢å»ã€‚</li>
</ol>

<p>æˆ‘ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œï¼Œä½ ä¸€å®šæœ‰å¾ˆå¤šç–‘é—®ï¼š</p>

<ol>
  <li>å®ƒæ€ä¹ˆçŸ¥é“è¦ä½¿ç”¨<code>AppModule</code></li>
  <li>å®ƒæ€ä¹ˆçŸ¥é“è¦buildä»€ä¹ˆæ ·çš„Componant</li>
  <li>å®ƒæ€ä¹ˆçŸ¥é“è¦æŠŠbuildå‡ºæ¥çš„Componentæ”¾åˆ°å“ªï¼Ÿ</li>
</ol>

<p>å¥½å§ï¼Œå…¶å®ä¸Šé¢çš„<code>DaggerRule</code>ï¼Œä¸æ˜¯DaggerMockè¿™ä¸ªlibraryè‡ªå¸¦çš„ï¼Œæ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„ã€‚ç„¶è€Œåˆ«ç€æ€¥ï¼ŒDaggerMockç»™äº†æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªçˆ¶ç±»Ruleï¼š<code>DaggerMockRule</code>ï¼Œè¿™ä¸ªRuleå·²ç»å¸®æˆ‘ä»¬åšäº†ç»å¤§å¤šæ•°äº‹æƒ…äº†ã€‚æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>DaggerRule</code>ï¼Œå…¶å®ä¹Ÿæ˜¯ç»§æ‰¿è‡ª<code>DaggerMockRule</code>çš„ï¼Œè€Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰Ruleé‡Œé¢åšçš„äº‹æƒ…ï¼Œä¹Ÿåªä¸è¿‡æ˜¯å‘Šè¯‰DaggerMockï¼Œä¸Šé¢è¯´åˆ°çš„ä¸‰ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼šè¦ä½¿ç”¨å“ªä¸ªModuleã€è¦buildå“ªä¸ªComponentã€è¦æŠŠbuildå¥½çš„Componentæ”¾åˆ°å“ªï¼Œä»…æ­¤è€Œå·²ã€‚ä¸ä¿¡è¯·çœ‹ä»£ç ï¼š</p>

<pre><code class="language-java">public class DaggerRule extends DaggerMockRule&lt;AppComponent&gt; {
    public DaggerRule() {
        //å‘Šè¯‰DaggerMockè¦buildä»€ä¹ˆæ ·çš„Componentï¼Œä½¿ç”¨å“ªä¸ªmodule
        super(AppComponent.class, new AppModule(RuntimeEnvironment.application));
        
        //å‘Šè¯‰DaggerMockæŠŠbuildå¥½çš„Componentæ”¾åˆ°å“ª
        set(new ComponentSetter&lt;AppComponent&gt;() {
            @Override
            public void setComponent(AppComponent appComponent) {
                ComponentHolder.setAppComponent(appComponent);
            }
        });
    }
}
</code></pre>

<p>æ€ä¹ˆæ ·ï¼Œå¾ˆç®€å•å§ï¼Ÿè¿™ä¸ªDaggerRuleæ˜¯å¯ä»¥é‡å¤ä½¿ç”¨çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªComponentç±»å¯¹åº”äºä¸€ä¸ªè¿™æ ·çš„<code>DaggerRule</code>å°±å¥½äº†ã€‚è‡ªæ­¤ï¼Œä½ å¯ä»¥åªè´Ÿè´£ä½¿ç”¨<code>@Mock</code>æ¥å®šä¹‰mockäº†ï¼Œdaggerçš„äº‹æƒ…å°±äº¤ç»™è¿™ä¸ª<code>DaggerRule</code>å°±å¥½äº†ã€‚
æ˜¯ä¸æ˜¯å¾ˆçˆ½ï¼</p>

<p>å“¦å¯¹äº†ï¼Œå°†è¿™ä¸ªlibraryåŠ åˆ°é¡¹ç›®é‡Œé¢çš„å§¿åŠ¿è¯´ä¸€ä¸‹ï¼Œåœ¨build.gradleæ–‡ä»¶é‡Œé¢åŠ å…¥ï¼š</p>

<pre><code class="language-java">repositories {
    jcenter()
    maven { url "https://jitpack.io" }
}
</code></pre>

<p>å’Œ</p>

<pre><code class="language-java">dependencies {
    //...others dependencies

    testCompile 'com.github.fabioCollini:DaggerMock:0.6.1'
    androidTestCompile 'com.github.fabioCollini:DaggerMock:0.6.1' //å¦‚æœä½ éœ€è¦åœ¨Instrumentationã€Espressoã€UiAutomatoré‡Œé¢ä½¿ç”¨çš„è¯
}
</code></pre>

<p>æˆ‘åˆšå¼€å§‹ä½¿ç”¨è¿™ä¸ªlibçš„æ—¶å€™ï¼Œè¿˜æ˜¯èŠ±äº†ç‚¹æ—¶é—´æ¥ç†è§£çš„ï¼Œä¸ªäººè®¤ä¸ºä½œè€…çš„<a href="https://github.com/fabioCollini/DaggerMock">README</a>å’Œå¯¹åº”çš„<a href="https://medium.com/@fabioCollini/android-testing-using-dagger-2-mockito-and-a-custom-junit-rule-c8487ed01b56">æ–‡ç« </a>å†™å¾—éƒ½ä¸ç®—æ˜¯å¾ˆå®¹æ˜“çœ‹æ‡‚ï¼Œå¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©å¸®åŠ©åˆ°å„ä½ä¸€ç‚¹ç‚¹ã€‚</p>

<p>ç…§ä¾‹æ–‡ä¸­çš„ä»£ç åœ¨<a href="https://github.com/ChrisZou/android-unit-testing-tutorial">githubçš„è¿™ä¸ªrepo</a>ã€‚<br />
å¦‚æœä½ ä¹Ÿå¯¹å®‰å“å•å…ƒæµ‹è¯•æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åŠ å…¥æˆ‘ä»¬çš„äº¤æµç¾¤ï¼Œå…³æ³¨å…¬ä¼—å·æŸ¥çœ‹æ€ä¹ˆåŠ å…¥ã€‚</p>

:ET